/*  backbone.fetch-cache v0.1.5 (2013-05-12)
  by Andy Appleton - https://github.com/mrappleton/backbone-fetch-cache.git
 */
(function(e,t){"function"==typeof define&&define.amd?define(["underscore","backbone"],function(_,Backbone){return e.Backbone=t(_,Backbone)}):e.Backbone=t(e._,e.Backbone)})(this,function(_,Backbone){function e(e,t,c){t=t||{};var i=_.isFunction(e.url)?e.url():e.url,h=!1;i&&t.cache!==!1&&(t.cache||t.prefill)&&(t.expires!==!1&&(h=(new Date).getTime()+1e3*(t.expires||300)),Backbone.fetchCache._cache[i]={expires:h,value:c},Backbone.fetchCache.setLocalStorage())}function t(e){delete Backbone.fetchCache._cache[e]}function c(){if(r&&Backbone.fetchCache.localStorage)try{localStorage.setItem("backboneCache",JSON.stringify(Backbone.fetchCache._cache))}catch(e){var t=e.code||e.number||e.message;if(22!==t)throw e;this._deleteCacheWithPriority()}}function i(){if(r&&Backbone.fetchCache.localStorage){var e=localStorage.getItem("backboneCache")||"{}";Backbone.fetchCache._cache=JSON.parse(e)}}var h={modelFetch:Backbone.Model.prototype.fetch,modelSync:Backbone.Model.prototype.sync,collectionFetch:Backbone.Collection.prototype.fetch},r=window.localStorage!==void 0;return Backbone.fetchCache=Backbone.fetchCache||{},Backbone.fetchCache._cache=Backbone.fetchCache._cache||{},Backbone.fetchCache.priorityFn=function(e,t){return e&&e.expires&&t&&t.expires?e.expires-t.expires:e},Backbone.fetchCache._prioritize=function(){var e=_.values(this._cache).sort(this.priorityFn),t=_.indexOf(_.values(this._cache),e[0]);return _.keys(this._cache)[t]},Backbone.fetchCache._deleteCacheWithPriority=function(){Backbone.fetchCache._cache[this._prioritize()]=null,delete Backbone.fetchCache._cache[this._prioritize()],Backbone.fetchCache.setLocalStorage()},Backbone.fetchCache.localStorage===void 0&&(Backbone.fetchCache.localStorage=!0),Backbone.Model.prototype.fetch=function(e){e=e||{};var t=_.isFunction(this.url)?this.url():this.url,c=Backbone.fetchCache._cache[t],i=!1,r=!1,a=new $.Deferred;if(c&&(i=c.expires,i=i&&c.expires<(new Date).getTime(),r=c.value),!i&&(e.cache||e.prefill)&&r){if(this.set(r,e),_.isFunction(e.prefillSuccess)&&e.prefillSuccess(this),!e.prefill)return _.isFunction(e.success)&&e.success(this),a.resolve(this);a.notify(this)}return h.modelFetch.apply(this,arguments).done(_.bind(a.resolve,this,this)).done(_.bind(Backbone.fetchCache.setCache,null,this,e)).fail(_.bind(a.reject,this,this)),a},Backbone.Model.prototype.sync=function(e,c){if("read"===e)return h.modelSync.apply(this,arguments);var i,r,a=c.collection,s=[];for(s.push(_.isFunction(c.url)?c.url():c.url),a&&s.push(_.isFunction(a.url)?a.url():a.url),i=0,r=s.length;r>i;i++)t(s[i]);return h.modelSync.apply(this,arguments)},Backbone.Collection.prototype.fetch=function(e){e=e||{};var t=_.isFunction(this.url)?this.url():this.url,c=Backbone.fetchCache._cache[t],i=!1,r=!1,a=new $.Deferred;if(c&&(i=c.expires,i=i&&c.expires<(new Date).getTime(),r=c.value),!i&&(e.cache||e.prefill)&&r){if(this[e.add?"add":"reset"](this.parse(r),e),_.isFunction(e.prefillSuccess)&&e.prefillSuccess(this),!e.prefill)return _.isFunction(e.success)&&e.success(this),a.resolve(this);a.notify(this)}return h.collectionFetch.apply(this,arguments).done(_.bind(a.resolve,this,this)).done(_.bind(Backbone.fetchCache.setCache,null,this,e)).fail(_.bind(a.reject,this,this)),a},i(),Backbone.fetchCache._superMethods=h,Backbone.fetchCache.setCache=e,Backbone.fetchCache.clearItem=t,Backbone.fetchCache.setLocalStorage=c,Backbone.fetchCache.getLocalStorage=i,Backbone});