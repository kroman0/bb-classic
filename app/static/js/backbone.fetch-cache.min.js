/*  backbone.fetch-cache v0.1.3 (2013-04-27)
  by Andy Appleton - https://github.com/mrappleton/backbone-fetch-cache.git
 */
(function(e,t){"function"==typeof define&&define.amd?define(["underscore","backbone"],function(_,Backbone){return e.Backbone=t(_,Backbone)}):e.Backbone=t(e._,e.Backbone)})(this,function(_,Backbone){function e(e,t,c){t=t||{};var i=_.isFunction(e.url)?e.url():e.url,h=!1;i&&(t.expires!==!1&&(h=(new Date).getTime()+1e3*(t.expires||300)),Backbone.fetchCache._cache[i]={expires:h,value:c},Backbone.fetchCache.setLocalStorage())}function t(){if(a&&Backbone.fetchCache.localStorage)try{localStorage.setItem("backboneCache",JSON.stringify(Backbone.fetchCache._cache))}catch(e){if("QUOTA_EXCEEDED_ERR"!==e.name.toUpperCase())throw e;this._deleteCacheWithPriority()}}function c(){a&&Backbone.fetchCache.localStorage&&(Backbone.fetchCache._cache=JSON.parse(localStorage.getItem("backboneCache"))||{})}var i=Backbone.Model.prototype.fetch,h=Backbone.Collection.prototype.fetch,a=window.localStorage!==void 0;return Backbone.fetchCache=Backbone.fetchCache||{},Backbone.fetchCache._cache=Backbone.fetchCache._cache||{},Backbone.fetchCache.priorityFn=function(e,t){return e&&e.expires&&t&&t.expires?e.expires-t.expires:e},Backbone.fetchCache._prioritize=function(){var e=_.values(this._cache).sort(this.priorityFn),t=_.indexOf(_.values(this._cache),e[0]);return _.keys(this._cache)[t]},Backbone.fetchCache._deleteCacheWithPriority=function(){Backbone.fetchCache._cache[this._prioritize()]=null,delete Backbone.fetchCache._cache[this._prioritize()];try{localStorage.setItem("backboneCache",JSON.stringify(Backbone.fetchCache._cache))}catch(e){if("QUOTA_EXCEEDED_ERR"!==e.name.toUpperCase())throw e;this._deleteCacheWithPriority()}},Backbone.fetchCache.localStorage===void 0&&(Backbone.fetchCache.localStorage=!0),Backbone.Model.prototype.fetch=function(e){e=e||{};var t=_.isFunction(this.url)?this.url():this.url,c=Backbone.fetchCache._cache[t],h=!1,a=!1,r=new $.Deferred;if(c&&(h=c.expires,h=h&&c.expires<(new Date).getTime(),a=c.value),!h&&(e.cache||e.prefill)&&a){if(this.set(a,e),_.isFunction(e.prefillSuccess)&&e.prefillSuccess(this),!e.prefill)return _.isFunction(e.success)&&e.success(this),r.resolve(this);r.notify(this)}return i.apply(this,arguments).done(_.bind(r.resolve,this,this)).done(_.bind(Backbone.fetchCache.setCache,null,this,e)),r},Backbone.Collection.prototype.fetch=function(e){e=e||{};var t=_.isFunction(this.url)?this.url():this.url,c=Backbone.fetchCache._cache[t],i=!1,a=!1,r=new $.Deferred;if(c&&(i=c.expires,i=i&&c.expires<(new Date).getTime(),a=c.value),!i&&(e.cache||e.prefill)&&a){if(this[e.add?"add":"reset"](this.parse(a),e),_.isFunction(e.prefillSuccess)&&e.prefillSuccess(this),!e.prefill)return _.isFunction(e.success)&&e.success(this),r.resolve(this);r.notify(this)}return h.apply(this,arguments).done(_.bind(r.resolve,this,this)).done(_.bind(Backbone.fetchCache.setCache,null,this,e)),r},c(),Backbone.fetchCache.setCache=e,Backbone.fetchCache.setLocalStorage=t,Backbone.fetchCache.getLocalStorage=c,Backbone});