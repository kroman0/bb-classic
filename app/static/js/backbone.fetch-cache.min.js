/*  backbone.fetch-cache v0.1.2 (2013-04-16)
  by Andy Appleton - https://github.com/mrappleton/backbone-fetch-cache.git
 */
(function(e,c){"function"==typeof define&&define.amd?define(["underscore","backbone"],function(_,Backbone){return e.Backbone=c(_,Backbone)}):e.Backbone=c(e._,e.Backbone)})(this,function(_,Backbone){function e(e,c,t){c=c||{};var i=_.isFunction(e.url)?e.url():e.url,h=!1;i&&(c.expires!==!1&&(h=(new Date).getTime()+1e3*(c.expires||300)),Backbone.fetchCache._cache[i]={expires:h,value:t},Backbone.fetchCache.setLocalStorage())}function c(){a&&Backbone.fetchCache.localStorage&&localStorage.setItem("backboneCache",JSON.stringify(Backbone.fetchCache._cache))}function t(){a&&Backbone.fetchCache.localStorage&&(Backbone.fetchCache._cache=JSON.parse(localStorage.getItem("backboneCache"))||{})}var i=Backbone.Model.prototype.fetch,h=Backbone.Collection.prototype.fetch,a=window.localStorage!==void 0;return Backbone.fetchCache=Backbone.fetchCache||{},Backbone.fetchCache._cache=Backbone.fetchCache._cache||{},Backbone.fetchCache.localStorage===void 0&&(Backbone.fetchCache.localStorage=!0),Backbone.Model.prototype.fetch=function(e){e=e||{};var c=_.isFunction(this.url)?this.url():this.url,t=Backbone.fetchCache._cache[c],h=!1,a=!1,s=new $.Deferred;if(t&&(h=t.expires,h=h&&t.expires<(new Date).getTime(),a=t.value),!h&&(e.cache||e.prefill)&&a){if(this.set(a,e),_.isFunction(e.prefillSuccess)&&e.prefillSuccess(this),!e.prefill)return _.isFunction(e.success)&&e.success(this),s.resolve(this);s.notify(this)}return i.apply(this,arguments).done(_.bind(s.resolve,this,this)).done(_.bind(Backbone.fetchCache.setCache,null,this,e)),s},Backbone.Collection.prototype.fetch=function(e){e=e||{};var c=_.isFunction(this.url)?this.url():this.url,t=Backbone.fetchCache._cache[c],i=!1,a=!1,s=new $.Deferred;if(t&&(i=t.expires,i=i&&t.expires<(new Date).getTime(),a=t.value),!i&&(e.cache||e.prefill)&&a){if(this[e.add?"add":"reset"](this.parse(a),e),_.isFunction(e.prefillSuccess)&&e.prefillSuccess(this),!e.prefill)return _.isFunction(e.success)&&e.success(this),s.resolve(this);s.notify(this)}return h.apply(this,arguments).done(_.bind(s.resolve,this,this)).done(_.bind(Backbone.fetchCache.setCache,null,this,e)),s},t(),Backbone.fetchCache.setCache=e,Backbone.fetchCache.setLocalStorage=c,Backbone.fetchCache.getLocalStorage=t,Backbone});