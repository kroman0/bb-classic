!function(e,t){"use strict";if(typeof e.define==="function"&&e.define.amd){e.define("bbmain",["jquery","underscore","backbone","bbgeneral","bbmodels","bbcollections","bbviews","backboneanalytics"],t)}else{e.BB=t(e.jQuery,e._,e.Backbone,e.bbgeneral,e.bbmodels,e.bbcollections,e.bbviews)}}(this,function(e,t,o,i,n,r,s){"use strict";return;var l,c={},p={},a={},m=i.onReset,d={el:".content",collections:p},_,w,u,j=o.Router.extend({routes:{projects:"projects","projects:tab":"projects","projects/:id":"project","projects/:id/todo_lists":"project_todo_lists","projects/:id/todo_lists/:tlid":"project_todo_list","projects/:id/todo_lists/:tlid/:tiid":"project_todo_item","projects/:id/todo_lists/:tlid/:tiid/comments":"project_todo_item_comments","projects/:id/time_entries/todo_items/:tiid":"todo_time_entries","projects/:id/time_entries":"project_time_entries","projects/:id/people":"project_people","projects/:id/posts":"project_posts","projects/:id/posts/:pid":"project_post","projects/:id/posts/:pid/comments":"project_post_comments","projects/:id/files":"project_files","projects/:id/files/:fid":"project_file","projects/:id/calendar":"project_calendar","projects/:id/calendar/:cid":"project_calendar_entry","projects/:id/calendar/:cid/comments":"project_calendar_entry_comments","projects/:id/categories":"project_categories","projects/:id/categories/:cid":"project_category",companies:"companies","companies/:id":"company",people:"people","people:tab":"people","people/:id":"person",me:"me",todos:"todos",time_report:"time_report","*actions":"defaultRoute"}}),f=function(e,t,o){if(t.get(e)){o.model=t.get(e)}else{o.model.id=e}return o.model},h=new j;c.mydata=new n.MyModel;c.project=new n.Project;c.company=new n.Company;c.person=new n.Person;p.projects=new r.Projects;p.companies=new r.Companies;p.people=new r.People;p.todos=new r.TodoLists;p.times=new r.TimeEntries;a.current=null;a.projects=new s.ProjectsView(t.extend({collection:p.projects},d));a.companies=new s.CompaniesView(t.extend({collection:p.companies},d));a.people=new s.AllPeopleView(t.extend({collection:p.people},d));a.time_report=new s.TimeReportView(t.extend({collection:p.times},d));a.todos=new s.TodosView(t.extend({collection:p.todos,mydata:c.mydata},d));for(l in p){if(p.hasOwnProperty(l)){p[l].on("reset",m)}}p.project_people=new r.People;p.project_categories=new r.Categories;p.project_posts=new r.Posts;p.project_files=new r.Attachments;p.project_todo_lists=new r.TodoLists;p.project_calendar=new r.Calendar;p.project_time_entries=new r.TimeEntries;p.todo_items=new r.TodoItems;p.todo_time_entries=new r.TodoTimeEntries;p.project_todo_item_comments=new r.TodoComments;p.project_post_comments=new r.PostComments;p.project_calendar_entry_comments=new r.CalendarEntryComments;a.company_view=new s.CompanyView(t.extend({model:c.company},d));a.person_view=new s.PersonView(t.extend({model:c.person},d));_=t.extend({model:c.project},d);a.project_view=new s.ProjectView(_);a.project_people=new s.PeopleView(_);a.project_categories=new s.CategoriesView(_);a.project_category=new s.CategoryView(_);a.project_posts=new s.PostsView(_);a.project_post=new s.PostView(_);a.project_calendar=new s.CalendarView(_);a.project_calendar_entry=new s.CalendarEntryView(_);a.project_files=new s.FilesView(_);a.project_file=new s.FileView(_);u=t.extend({mydata:c.mydata},_);a.project_time_entries=new s.TimeEntriesView(u);a.todo_time_entries=new s.TodoTimeEntriesView(u);a.project_post_comments=new s.PostCommentsView(_);a.project_calendar_entry_comments=new s.CalendarEntryCommentsView(_);a.todo=function(e,t){if(!a.todo[t.id]){a.todo[t.id]=new s.TodoView({model:t,collections:p,project_id:e})}return a.todo[t.id]};w=t.extend({todo:a.todo},_);a.project_todo_lists=new s.TodoListsView(w);a.project_todo_list=new s.TodoListView(w);a.project_todo_item=new s.TodoItemView(w);a.project_todo_item_comments=new s.TodoItemCommentsView(w);h.on("route",function(o,i){var n,r;if(t.contains(["projects","companies","people","time_report","todos"],o)){a.current=a[o].render()}else if(t.contains(["project_people","project_categories","project_time_entries","project_posts","project_files","project_calendar","project_todo_lists"],o)){n=parseInt(i[0],10);f(n,p.projects,a[o]);a[o].collection=p[o].get_or_create(n);a.current=a[o].render()}else if(t.contains(["project_post","project_file","project_calendar_entry","project_category","project_todo_list","project_calendar_entry_comments","project_post_comments","todo_time_entries"],o)){n=parseInt(i[0],10);r=parseInt(i[1],10);f(n,p.projects,a[o]);a[o].cur_item=r;switch(o){case"project_calendar_entry":a[o].collection=p.project_calendar.get_or_create(n);break;case"project_category":a[o].collection=p.project_categories.get_or_create(n);break;case"project_post":case"project_file":case"project_todo_list":a[o].collection=p[o+"s"].get_or_create(n);break;default:a[o].collection=p[o].get_or_create(r)}a.current=a[o].render()}if(a.current){document.title=a.current.PageTitle()}if(a.current&&a.current.deps){a.current.deps()}e(t.filter(e(".navbar ul.nav li").removeClass("active"),function(t){return e(t).find("a:visible")[0]&&document.location.hash.indexOf(e(t).find("a:visible")[0].hash)!==-1})).addClass("active");e(t.filter(e("div.content ul.projectnav li").removeClass("active"),function(t){return e(t).find("a:visible")[0]&&document.location.hash.indexOf(e(t).find("a:visible")[0].hash)!==-1})).filter(":last").addClass("active")}).on("route:project_todo_item",function(e,t,o){f(e,p.projects,a.project_todo_item);a.project_todo_item.cur_item=t;a.project_todo_item.todo_item=o;a.project_todo_item.collection=a.project_todo_item.todo_lists=p.project_todo_lists.get_or_create(e);a.current=a.project_todo_item.render()}).on("route:project_todo_item_comments",function(e,t,o){f(e,p.projects,a.project_todo_item_comments);a.project_todo_item_comments.cur_item=t;a.project_todo_item_comments.todo_item=o;a.project_todo_item_comments.todo_lists=p.project_todo_lists.get_or_create(e);a.project_todo_item_comments.collection=p.project_todo_item_comments.get_or_create(o);a.current=a.project_todo_item_comments.render()}).on("route:project",function(e){f(e,p.projects,a.project_view);a.current=a.project_view.render()}).on("route:company",function(e){f(e,p.companies,a.company_view);a.current=a.company_view.render()}).on("route:person",function(e){f(e,p.people,a.person_view);a.current=a.person_view.render()}).on("route:me",function(){a.person_view.model=c.mydata;a.current=a.person_view.render()}).on("route:defaultRoute",function(){this.navigate("projects",{trigger:true})});a.navbar=new s.NavView({model:c.mydata,el:".navbar"}).render();c.mydata.once("sync",function(){o.history.start()});c.mydata.fetch();return{models:c,collections:p,views:a,workspace:h}});"use strict";var BB=window.BB=new Backbone.Marionette.Application;Backbone.Marionette.TemplateCache.prototype.loadTemplate=function(e){var t=window.templates[e];if(!t||t.length===0){throwError("Could not find template: '"+e+"'","NoTemplateError")}return t};BB.collections={};BB.views={};BB.addRegions({navRegion:"#navbar",headerRegion:"#header",mainRegion:"#content"});BB.module("Projects",function(e,t,o,i,n,r){e.Model=o.Model.extend({urlRoot:"/api/projects/",icon:function(){switch(this.get("status")){case"active":return"icon-play";case"archived":return"icon-stop";case"on_hold":return"icon-pause"}}});e.Collection=o.Collection.extend({url:"/api/projects.xml",model:e.Model});e.ItemView=i.ItemView.extend({tagName:"li",template:"#oneproject-template"});e.EmptyView=i.ItemView.extend({template:"#emptyprojects-template"});e.View=i.CompositeView.extend({id:"projects",template:"#projects-template",itemView:e.ItemView,emptyView:e.EmptyView,templateHelpers:function(){return{view:this}},name:function(){return"Projects"},appendHtml:function(e,t){if(t.model.get("company")){var o=t.model.get("company").id,i=t.model.get("status"),n="#projects_"+i+"_"+o+" ul";e.$(n).append(t.el)}else{e.$el.append(t.el)}},initialize:function(){this.collection.bind("sync",this.render,this)}});e.Header=i.View.extend({className:"page-header",template:"#header1-template",render:function(){this.$el.html(r.template(window.templates[this.template],this.name(),{variable:"name"}));return this},name:function(){return"Projects"}});t.on("initialize:before",function(o){t.collections.projects=new e.Collection;t.views.projectsView=new e.View({collection:t.collections.projects});t.views.projectsHeader=new e.Header({collection:t.collections.projects})})});BB.module("Companies",function(e,t,o,i,n,r){e.Model=o.Model.extend({urlRoot:"/api/companies/"});e.Collection=o.Collection.extend({url:"/api/companies.xml",model:e.Model});e.ItemView=i.ItemView.extend({tagName:"li",template:"#onecompany-template"});e.EmptyView=i.ItemView.extend({tagName:"li",template:"#emptycompanies-template"});e.View=i.CompositeView.extend({tagName:"ul",id:"companies",className:"unstyled",template:"#companies-template",itemView:e.ItemView,emptyView:e.EmptyView,name:function(){return"Companies"},appendHtml:function(e,t){e.$el.append(t.el)},initialize:function(){this.collection.bind("sync",this.render,this)}});e.Header=i.View.extend({className:"page-header",template:"#header1-template",render:function(){this.$el.html(r.template(window.templates[this.template],this.name(),{variable:"name"}));return this},name:function(){return"Companies"}});t.on("initialize:before",function(o){t.collections.companies=new e.Collection;t.views.companiesView=new e.View({collection:t.collections.companies});t.views.companiesHeader=new e.Header({collection:t.collections.companies})})});BB.module("People",function(e,t,o,i,n,r){e.Model=o.Model.extend({urlRoot:"/api/people/",name:function(){return this.get("first-name")+" "+this.get("last-name")}});e.Collection=o.Collection.extend({parent_id:null,url:function(){if(this.parent_id){return"/api/projects/"+this.parent_id+"/people.xml"}return"/api/people.xml"},model:e.Model});e.ItemView=i.ItemView.extend({templateHelpers:function(){return{item:this.model}},tagName:"li",className:"media well well-small",template:"#personitem-template"});e.EmptyView=i.ItemView.extend({template:"#emptypeople-template"});e.View=i.CompositeView.extend({id:"people",template:"#people-template",itemView:e.ItemView,emptyView:e.EmptyView,templateHelpers:function(){return{view:this}},appendHtml:function(e,t){if(t.model.get("company")){var o=t.model.get("company").id,i="#people_c"+o+" ul.media-list";if(e.$(i).length){e.$(i).append(t.el)}else{e.$("ul.media-list").append(t.el)}}else{e.$el.append(t.el)}},initialize:function(){this.collection.bind("sync",this.render,this)}});e.Header=i.View.extend({className:"page-header",template:"#header1-template",render:function(){this.$el.html(r.template(window.templates[this.template],this.name(),{variable:"name"}));return this},name:function(){return"People"}});e.PersonView=i.ItemView.extend({templateHelpers:function(){return{item:this.model}},template:"#person-template"});e.PersonHeader=i.View.extend({className:"page-header",template:"#header1-template",render:function(){this.$el.html(r.template(window.templates[this.template],this.name(),{variable:"name"}));return this},name:function(){return this.model.name()}});t.on("initialize:before",function(o){t.collections.people=new e.Collection;t.views.peopleView=new e.View({collection:t.collections.people});t.views.peopleHeader=new e.Header({collection:t.collections.people});t.views.personView=new e.PersonView({model:new e.Model});t.views.personHeader=new e.PersonHeader({model:new e.Model})})});BB.module("Time",function(e,t,o,i,n,r){e.Model=o.Model.extend({urlRoot:"/api/time_entries/"});e.Collection=o.PageableCollection.extend({mode:"client",parent_id:null,parent:"projects",filter_report:null,url:function(){if(r.isFinite(this.parent_id)){return"/api/"+this.parent+"/"+this.parent_id+"/time_entries.xml"}if(this.filter_report){return"/api/time_entries/report.xml?"+this.filter_report}return"/api/time_entries/report.xml"},model:e.Model});e.ItemView=i.ItemView.extend({templateHelpers:function(){return{item:this.model}},tagName:"tr",className:function(){return this.model.get("hours")>2?"warning":undefined},template:"#time-template"});e.EmptyView=i.ItemView.extend({template:"#emptytime-template"});e.View=i.CompositeView.extend({id:"time-report",template:"#time-report-template",itemView:e.ItemView,emptyView:e.EmptyView,pagerid:"time-report",events:{"click .time-report.previous":"previous","click .time-report.next":"next","click #getreport":"getreport"},previous:function(e){e.preventDefault();return this.collection.hasPrevious()&&this.collection.getPreviousPage()&&this.render()},next:function(e){e.preventDefault();return this.collection.hasNext()&&this.collection.getNextPage()&&this.render()},getreport:function(e){e.preventDefault();this.collection.filter_report=n.param(r.filter(this.$("form#makereport").serializeArray(),function(e){return e.value}));this.collection.fetch({cache:true})},renderpager:function(){return r.template(window.templates["#pager-template"],this,{variable:"view"})},templateHelpers:function(){return{view:this}},appendHtml:function(e,t){if(r.isFinite(t.model.get("project-id"))){var o=t.model.get("project-id"),i="#times_p"+o;e.$(i).after(t.el)}else{e.$el.append(t.el)}},initialize:function(){this.collection.bind("sync",this.render,this)}});e.Header=i.View.extend({className:"page-header",template:"#header1-template",render:function(){this.$el.html(r.template(window.templates[this.template],this.name(),{variable:"name"}));return this},name:function(){return"Time report"}});t.on("initialize:before",function(o){t.collections.times=new e.Collection;t.views.timesView=new e.View({collection:t.collections.times});t.views.timesHeader=new e.Header({collection:t.collections.times})})});BB.module("Todo",function(e,t,o,i,n,r){e.Model=o.Model.extend({urlRoot:"/api/todo_items/",complete:function(){this.save("completed",true,{url:r.result(this,"url").replace(".xml","/complete.xml")})},uncomplete:function(){this.save("completed",false,{url:r.result(this,"url").replace(".xml","/uncomplete.xml")})}});e.Collection=o.Collection.extend({responsible_party:null,parent_id:null,filter_status:null,url:function(){if(r.isFinite(this.parent_id)&&this.filter_status){return"/api/projects/"+this.parent_id+"/todo_lists.xml?filter="+this.filter_status}if(r.isFinite(this.parent_id)){return"/api/projects/"+this.parent_id+"/todo_lists.xml"}if(this.responsible_party===null){return"/api/todo_lists.xml"}if(this.responsible_party===""){return"/api/todo_lists.xml?responsible_party="}return"/api/todo_lists.xml?responsible_party="+this.responsible_party},model:e.Model});e.ItemView=i.ItemView.extend({templateHelpers:function(){return{list:this.model}},tagName:"dl",template:"#todolist-template"});e.EmptyView=i.ItemView.extend({tagName:"li",template:"#emptytodos-template"});e.View=i.CompositeView.extend({tagName:"ul",id:"todos",className:"unstyled",template:"#todo-lists-template",itemView:e.ItemView,emptyView:e.EmptyView,events:{"change select[name='target']":"selectTarget"},selectTarget:function(e){console.log("selectTarget");this.collection.responsible_party=n(e.target).val();this.collection.fetch({cache:true})},templateHelpers:function(){return{view:this}},appendHtml:function(e,t){if(r.isFinite(t.model.get("project-id"))){var o=t.model.get("project-id"),i="#todos_p"+o;e.$(i).append(t.el)}else{e.$el.append(t.el)}},initialize:function(){this.collection.bind("sync",this.render,this)},description:function(){if(this.collection.responsible_party){var e=t.collections.people&&t.collections.people.get(this.collection.responsible_party);return e?e.name()+"'s":this.collection.responsible_party+"'s"}if(this.collection.responsible_party===null){return"My"}if(this.collection.responsible_party===""){return"Unassigned"}return"All"}});e.Header=i.View.extend({className:"page-header",template:"#header1-template",render:function(){this.$el.html(r.template(window.templates[this.template],this.name(),{variable:"name"}));return this},name:function(){if(this.collection.responsible_party){var e=t.collections.people&&t.collections.people.get(this.collection.responsible_party);return e?e.name()+"'s to-dos":this.collection.responsible_party+"'s to-dos"}if(this.collection.responsible_party===null){return"My to-dos"}if(this.collection.responsible_party===""){return"Unassigned to-dos"}return"To-dos"}});t.on("initialize:before",function(o){t.collections.todos=new e.Collection;t.views.todosView=new e.View({collection:t.collections.todos});t.views.todosHeader=new e.Header({collection:t.collections.todos})})});BB.module("Base",function(e,t,o,i,n,r){e.Me=t.People.Model.extend({url:"/api/me.xml"});var s=e.NavBarView=i.View.extend({template:"#nav-template",className:"navbar-inner",render:function(){this.$el.html(r.template(window.templates[this.template],this,{variable:"view"}));return this},initialize:function(){this.model.bind("change",this.render,this)}});t.on("initialize:before",function(o){t.me=new e.Me;var i=new e.NavBarView({model:t.me});t.navRegion.show(i)})});BB.addInitializer(function(e){BB.me.fetch();BB.collections.projects.fetch();BB.collections.companies.fetch();BB.collections.people.fetch();BB.collections.times.fetch();BB.collections.todos.fetch()});var Workspace=Backbone.Router.extend({routes:{projects:"projects","projects:tab":"projects","projects/:id":"project","projects/:id/todo_lists":"project_todo_lists","projects/:id/todo_lists/:tlid":"project_todo_list","projects/:id/todo_lists/:tlid/:tiid":"project_todo_item","projects/:id/todo_lists/:tlid/:tiid/comments":"project_todo_item_comments","projects/:id/time_entries/todo_items/:tiid":"todo_time_entries","projects/:id/time_entries":"project_time_entries","projects/:id/people":"project_people","projects/:id/posts":"project_posts","projects/:id/posts/:pid":"project_post","projects/:id/posts/:pid/comments":"project_post_comments","projects/:id/files":"project_files","projects/:id/files/:fid":"project_file","projects/:id/calendar":"project_calendar","projects/:id/calendar/:cid":"project_calendar_entry","projects/:id/calendar/:cid/comments":"project_calendar_entry_comments","projects/:id/categories":"project_categories","projects/:id/categories/:cid":"project_category",companies:"companies","companies/:id":"company",people:"people","people:tab":"people","people/:id":"person",me:"me",todos:"todos",time_report:"time_report","*actions":"defaultRoute"}});var workspace=new Workspace;workspace.on("route",function(e,t){console.log(e,t)}).on("route:projects",function(){BB.headerRegion.show(BB.views.projectsHeader);BB.mainRegion.show(BB.views.projectsView)}).on("route:companies",function(){BB.headerRegion.show(BB.views.companiesHeader);BB.mainRegion.show(BB.views.companiesView)}).on("route:people",function(){BB.headerRegion.show(BB.views.peopleHeader);BB.mainRegion.show(BB.views.peopleView)}).on("route:time_report",function(){BB.headerRegion.show(BB.views.timesHeader);BB.mainRegion.show(BB.views.timesView)}).on("route:todos",function(){BB.headerRegion.show(BB.views.todosHeader);BB.mainRegion.show(BB.views.todosView)}).on("route:me",function(){BB.views.personHeader.model=BB.me;BB.views.personView.model=BB.me;BB.headerRegion.show(BB.views.personHeader);BB.mainRegion.show(BB.views.personView)}).on("route:person",function(e){BB.views.personHeader.model=BB.collections.people.get(e);BB.views.personView.model=BB.collections.people.get(e);BB.headerRegion.show(BB.views.personHeader);BB.mainRegion.show(BB.views.personView)}).on("route:defaultRoute",function(e){this.navigate("projects",{trigger:true})});BB.on("initialize:after",function(e){if(Backbone.history){Backbone.history.start()}});$(document).ready(function(){BB.start()});