!function(e,t){"use strict";"function"==typeof e.define&&e.define.amd?e.define("bbmain",["jquery","underscore","backbone","bbgeneral","bbmodels","bbcollections","bbviews","backboneanalytics"],t):e.BB=t(e.jQuery,e._,e.Backbone,e.bbgeneral,e.bbmodels,e.bbcollections,e.bbviews)}(this,function(e,t,i,o,n,l,s){"use strict";return});var BB=window.BB=new Backbone.Marionette.Application;Backbone.Marionette.TemplateCache.prototype.loadTemplate=function(e){var t=window.bbtemplates[e];return t&&0!==t.length||throwError("Could not find template: '"+e+"'","NoTemplateError"),t},BB.collections={},BB.views={},BB.addRegions({navRegion:"#navbar",headerRegion:"#header",mainRegion:"#content"}),BB.module("Projects",function(e,t,i,o,n,l){e.Model=i.Model.extend({urlRoot:"/api/projects/",icon:function(){switch(this.get("status")){case"active":return"icon-play";case"archived":return"icon-stop";case"on_hold":return"icon-pause"}}}),e.Collection=i.Collection.extend({url:"/api/projects.xml",model:e.Model}),e.ItemView=o.ItemView.extend({tagName:"li",template:"#oneproject"}),e.EmptyView=o.ItemView.extend({template:"#emptyprojects"}),e.View=o.CompositeView.extend({id:"projects",template:"#projects",itemView:e.ItemView,emptyView:e.EmptyView,templateHelpers:function(){return{view:this}},name:function(){return"Projects"},appendHtml:function(e,t){if(t.model.get("company")){var i=t.model.get("company").id,o=t.model.get("status"),n="#projects_"+o+"_"+i+" ul";e.$(n).append(t.el)}else e.$el.append(t.el)},initialize:function(){this.collection.bind("sync",this.render,this)}}),e.Header=o.View.extend({className:"page-header",template:"#header1",render:function(){return this.$el.html(l.template(window.bbtemplates[this.template],this.name(),{variable:"name"})),this},name:function(){return"Projects"}}),t.on("initialize:before",function(){t.collections.projects=new e.Collection,t.views.projectsView=new e.View({collection:t.collections.projects}),t.views.projectsHeader=new e.Header({collection:t.collections.projects})})}),BB.module("Companies",function(e,t,i,o,n,l){e.Model=i.Model.extend({urlRoot:"/api/companies/"}),e.Collection=i.Collection.extend({url:"/api/companies.xml",model:e.Model}),e.ItemView=o.ItemView.extend({tagName:"li",template:"#onecompany"}),e.EmptyView=o.ItemView.extend({tagName:"li",template:"#emptycompanies"}),e.View=o.CompositeView.extend({tagName:"ul",id:"companies",className:"unstyled",template:"#companies",itemView:e.ItemView,emptyView:e.EmptyView,name:function(){return"Companies"},appendHtml:function(e,t){e.$el.append(t.el)},initialize:function(){this.collection.bind("sync",this.render,this)}}),e.Header=o.View.extend({className:"page-header",template:"#header1",render:function(){return this.$el.html(l.template(window.bbtemplates[this.template],this.name(),{variable:"name"})),this},name:function(){return"Companies"}}),t.on("initialize:before",function(){t.collections.companies=new e.Collection,t.views.companiesView=new e.View({collection:t.collections.companies}),t.views.companiesHeader=new e.Header({collection:t.collections.companies})})}),BB.module("People",function(e,t,i,o,n,l){e.Model=i.Model.extend({urlRoot:"/api/people/",name:function(){return this.get("first-name")+" "+this.get("last-name")}}),e.Collection=i.Collection.extend({parent_id:null,url:function(){return this.parent_id?"/api/projects/"+this.parent_id+"/people.xml":"/api/people.xml"},model:e.Model}),e.ItemView=o.ItemView.extend({templateHelpers:function(){return{item:this.model}},tagName:"li",className:"media well well-small",template:"#personitem"}),e.EmptyView=o.ItemView.extend({template:"#emptypeople"}),e.View=o.CompositeView.extend({id:"people",template:"#people",itemView:e.ItemView,emptyView:e.EmptyView,templateHelpers:function(){return{view:this}},appendHtml:function(e,t){if(t.model.get("company")){var i=t.model.get("company").id,o="#people_c"+i+" ul.media-list";e.$(o).length?e.$(o).append(t.el):e.$("ul.media-list").append(t.el)}else e.$el.append(t.el)},initialize:function(){this.collection.bind("sync",this.render,this)}}),e.Header=o.View.extend({className:"page-header",template:"#header1",render:function(){return this.$el.html(l.template(window.bbtemplates[this.template],this.name(),{variable:"name"})),this},name:function(){return"People"}}),e.PersonView=o.ItemView.extend({templateHelpers:function(){return{item:this.model}},template:"#person"}),e.PersonHeader=o.View.extend({className:"page-header",template:"#header1",render:function(){return this.$el.html(l.template(window.bbtemplates[this.template],this.name(),{variable:"name"})),this},name:function(){return this.model.name()}}),t.on("initialize:before",function(){t.collections.people=new e.Collection,t.views.peopleView=new e.View({collection:t.collections.people}),t.views.peopleHeader=new e.Header({collection:t.collections.people}),t.views.personView=new e.PersonView({model:new e.Model}),t.views.personHeader=new e.PersonHeader({model:new e.Model})})}),BB.module("Time",function(e,t,i,o,n,l){e.Model=i.Model.extend({urlRoot:"/api/time_entries/"}),e.Collection=i.PageableCollection.extend({mode:"client",parent_id:null,parent:"projects",filter_report:null,url:function(){return l.isFinite(this.parent_id)?"/api/"+this.parent+"/"+this.parent_id+"/time_entries.xml":this.filter_report?"/api/time_entries/report.xml?"+this.filter_report:"/api/time_entries/report.xml"},model:e.Model}),e.ItemView=o.ItemView.extend({templateHelpers:function(){return{item:this.model}},tagName:"tr",className:function(){return this.model.get("hours")>2?"warning":void 0},template:"#time"}),e.EmptyView=o.ItemView.extend({template:"#emptytime"}),e.View=o.CompositeView.extend({id:"time-report",template:"#time-report",itemView:e.ItemView,emptyView:e.EmptyView,pagerid:"time-report",events:{"click .time-report.previous":"previous","click .time-report.next":"next","click #getreport":"getreport"},previous:function(e){return e.preventDefault(),this.collection.hasPrevious()&&this.collection.getPreviousPage()&&this.render()},next:function(e){return e.preventDefault(),this.collection.hasNext()&&this.collection.getNextPage()&&this.render()},getreport:function(e){e.preventDefault(),this.collection.filter_report=n.param(l.filter(this.$("form#makereport").serializeArray(),function(e){return e.value})),this.collection.fetch({cache:!0})},renderpager:function(){return l.template(window.bbtemplates["#pager"],this,{variable:"view"})},templateHelpers:function(){return{view:this}},appendHtml:function(e,t){if(l.isFinite(t.model.get("project-id"))){var i=t.model.get("project-id"),o="#times_p"+i;e.$(o).after(t.el)}else e.$el.append(t.el)},initialize:function(){this.collection.bind("sync",this.render,this)}}),e.Header=o.View.extend({className:"page-header",template:"#header1",render:function(){return this.$el.html(l.template(window.bbtemplates[this.template],this.name(),{variable:"name"})),this},name:function(){return"Time report"}}),t.on("initialize:before",function(){t.collections.times=new e.Collection,t.views.timesView=new e.View({collection:t.collections.times}),t.views.timesHeader=new e.Header({collection:t.collections.times})})}),BB.module("Todo",function(e,t,i,o,n,l){e.Model=i.Model.extend({urlRoot:"/api/todo_items/",complete:function(){this.save("completed",!0,{url:l.result(this,"url").replace(".xml","/complete.xml")})},uncomplete:function(){this.save("completed",!1,{url:l.result(this,"url").replace(".xml","/uncomplete.xml")})}}),e.Collection=i.Collection.extend({responsible_party:null,parent_id:null,filter_status:null,url:function(){return l.isFinite(this.parent_id)&&this.filter_status?"/api/projects/"+this.parent_id+"/todo_lists.xml?filter="+this.filter_status:l.isFinite(this.parent_id)?"/api/projects/"+this.parent_id+"/todo_lists.xml":null===this.responsible_party?"/api/todo_lists.xml":""===this.responsible_party?"/api/todo_lists.xml?responsible_party=":"/api/todo_lists.xml?responsible_party="+this.responsible_party},model:e.Model}),e.ItemView=o.ItemView.extend({templateHelpers:function(){return{list:this.model}},tagName:"dl",template:"#todolist"}),e.EmptyView=o.ItemView.extend({tagName:"li",template:"#emptytodos"}),e.View=o.CompositeView.extend({tagName:"ul",id:"todos",className:"unstyled",template:"#todo-lists",itemView:e.ItemView,emptyView:e.EmptyView,events:{"change select[name='target']":"selectTarget"},selectTarget:function(e){console.log("selectTarget"),this.collection.responsible_party=n(e.target).val(),this.collection.fetch({cache:!0})},templateHelpers:function(){return{view:this}},appendHtml:function(e,t){if(l.isFinite(t.model.get("project-id"))){var i=t.model.get("project-id"),o="#todos_p"+i;e.$(o).append(t.el)}else e.$el.append(t.el)},initialize:function(){this.collection.bind("sync",this.render,this)},description:function(){if(this.collection.responsible_party){var e=t.collections.people&&t.collections.people.get(this.collection.responsible_party);return e?e.name()+"'s":this.collection.responsible_party+"'s"}return null===this.collection.responsible_party?"My":""===this.collection.responsible_party?"Unassigned":"All"}}),e.Header=o.View.extend({className:"page-header",template:"#header1",render:function(){return this.$el.html(l.template(window.bbtemplates[this.template],this.name(),{variable:"name"})),this},name:function(){if(this.collection.responsible_party){var e=t.collections.people&&t.collections.people.get(this.collection.responsible_party);return e?e.name()+"'s to-dos":this.collection.responsible_party+"'s to-dos"}return null===this.collection.responsible_party?"My to-dos":""===this.collection.responsible_party?"Unassigned to-dos":"To-dos"}}),t.on("initialize:before",function(){t.collections.todos=new e.Collection,t.views.todosView=new e.View({collection:t.collections.todos}),t.views.todosHeader=new e.Header({collection:t.collections.todos})})}),BB.module("Base",function(e,t,i,o,n,l){e.Me=t.People.Model.extend({url:"/api/me.xml"}),e.NavBarView=o.View.extend({template:"#nav",className:"navbar-inner",render:function(){return this.$el.html(l.template(window.bbtemplates[this.template],this,{variable:"view"})),this},initialize:function(){this.model.bind("change",this.render,this)}}),t.on("initialize:before",function(){t.me=new e.Me;var i=new e.NavBarView({model:t.me});t.navRegion.show(i)})}),BB.addInitializer(function(){BB.me.fetch(),BB.collections.projects.fetch(),BB.collections.companies.fetch(),BB.collections.people.fetch(),BB.collections.times.fetch(),BB.collections.todos.fetch()});var Workspace=Backbone.Router.extend({routes:{projects:"projects","projects:tab":"projects","projects/:id":"project","projects/:id/todo_lists":"project_todo_lists","projects/:id/todo_lists/:tlid":"project_todo_list","projects/:id/todo_lists/:tlid/:tiid":"project_todo_item","projects/:id/todo_lists/:tlid/:tiid/comments":"project_todo_item_comments","projects/:id/time_entries/todo_items/:tiid":"todo_time_entries","projects/:id/time_entries":"project_time_entries","projects/:id/people":"project_people","projects/:id/posts":"project_posts","projects/:id/posts/:pid":"project_post","projects/:id/posts/:pid/comments":"project_post_comments","projects/:id/files":"project_files","projects/:id/files/:fid":"project_file","projects/:id/calendar":"project_calendar","projects/:id/calendar/:cid":"project_calendar_entry","projects/:id/calendar/:cid/comments":"project_calendar_entry_comments","projects/:id/categories":"project_categories","projects/:id/categories/:cid":"project_category",companies:"companies","companies/:id":"company",people:"people","people:tab":"people","people/:id":"person",me:"me",todos:"todos",time_report:"time_report","*actions":"defaultRoute"}}),workspace=new Workspace;workspace.on("route",function(e,t){console.log(e,t)}).on("route:projects",function(){BB.headerRegion.show(BB.views.projectsHeader),BB.mainRegion.show(BB.views.projectsView)}).on("route:companies",function(){BB.headerRegion.show(BB.views.companiesHeader),BB.mainRegion.show(BB.views.companiesView)}).on("route:people",function(){BB.headerRegion.show(BB.views.peopleHeader),BB.mainRegion.show(BB.views.peopleView)}).on("route:time_report",function(){BB.headerRegion.show(BB.views.timesHeader),BB.mainRegion.show(BB.views.timesView)}).on("route:todos",function(){BB.headerRegion.show(BB.views.todosHeader),BB.mainRegion.show(BB.views.todosView)}).on("route:me",function(){BB.views.personHeader.model=BB.me,BB.views.personView.model=BB.me,BB.headerRegion.show(BB.views.personHeader),BB.mainRegion.show(BB.views.personView)}).on("route:person",function(e){BB.views.personHeader.model=BB.collections.people.get(e),BB.views.personView.model=BB.collections.people.get(e),BB.headerRegion.show(BB.views.personHeader),BB.mainRegion.show(BB.views.personView)}).on("route:defaultRoute",function(){this.navigate("projects",{trigger:!0})}),BB.on("initialize:after",function(){Backbone.history&&Backbone.history.start()}),$(document).ready(function(){BB.start()});