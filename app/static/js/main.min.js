!function(e,t){"use strict";"function"==typeof e.define&&e.define.amd?e.define("bbmain",["underscore","backbone","bbmodels","bbcollections","bbviews","backboneanalytics"],t):e.BB=t(e._,e.Backbone,e.bbmodels,e.bbcollections,e.bbviews)}(this,function(e,t,o,i,n){"use strict";if(!t.Marionette){var r,s,c={},l={},p={},a={el:".content",collections:l},m=t.Router.extend({routes:{projects:"projects","projects:tab":"projects","projects/:id":"project","projects/:id/todo_lists":"project_todo_lists","projects/:id/todo_lists/:tlid":"project_todo_list","projects/:id/todo_lists/:tlid/:tiid":"project_todo_item","projects/:id/todo_lists/:tlid/:tiid/comments":"project_todo_item_comments","projects/:id/time_entries/todo_items/:tiid":"todo_time_entries","projects/:id/time_entries":"project_time_entries","projects/:id/people":"project_people","projects/:id/people/:pid":"project_person","projects/:id/posts":"project_posts","projects/:id/posts/:pid":"project_post","projects/:id/posts/:pid/comments":"project_post_comments","projects/:id/files":"project_files","projects/:id/files/:fid":"project_file","projects/:id/calendar":"project_calendar","projects/:id/calendar/:cid":"project_calendar_entry","projects/:id/calendar/:cid/comments":"project_calendar_entry_comments","projects/:id/categories":"project_categories","projects/:id/categories/:cid":"project_category",companies:"companies","companies/:id":"company",people:"people","people:tab":"people","people/:id":"person",me:"me",todos:"todos",time_report:"time_report","*actions":"defaultRoute"}}),d=function(e,t,o){return t.get(e)?o.model=t.get(e):o.model.id=e,o.model},_=new m;return c.mydata=new o.MyModel,c.project=new o.Project,c.company=new o.Company,c.person=new o.Person,l.projects=new i.Projects,l.companies=new i.Companies,l.people=new i.People,l.todos=new i.TodoLists,l.times=new i.TimeEntries,p.current=null,p.projects=new n.ProjectsView(e.extend({collection:l.projects},a)),p.companies=new n.CompaniesView(e.extend({collection:l.companies},a)),p.people=new n.AllPeopleView(e.extend({collection:l.people},a)),p.time_report=new n.TimeReportView(e.extend({collection:l.times},a)),p.todos=new n.TodosView(e.extend({collection:l.todos,mydata:c.mydata},a)),l.project_people=new i.People,l.project_categories=new i.Categories,l.project_posts=new i.Posts,l.project_files=new i.Attachments,l.project_todo_lists=new i.TodoLists,l.project_calendar=new i.Calendar,l.project_time_entries=new i.TimeEntries,l.todo_items=new i.TodoItems,l.todo_time_entries=new i.TodoTimeEntries,l.project_todo_item_comments=new i.TodoComments,l.project_post_comments=new i.PostComments,l.project_calendar_entry_comments=new i.CalendarEntryComments,p.company_view=new n.CompanyView(e.extend({model:c.company},a)),p.person_view=new n.AllPersonView(e.extend({model:c.person},a)),r=e.extend({model:c.project},a),p.project_view=new n.ProjectView(r),p.project_people=new n.PeopleView(r),p.project_person=new n.PersonView(r),p.project_categories=new n.CategoriesView(r),p.project_category=new n.CategoryView(r),p.project_posts=new n.PostsView(r),p.project_post=new n.PostView(r),p.project_calendar=new n.CalendarView(r),p.project_calendar_entry=new n.CalendarEntryView(r),p.project_files=new n.FilesView(r),p.project_file=new n.FileView(r),s=e.extend({mydata:c.mydata},r),p.project_time_entries=new n.TimeEntriesView(s),p.todo_time_entries=new n.TodoTimeEntriesView(s),p.project_post_comments=new n.PostCommentsView(r),p.project_calendar_entry_comments=new n.CalendarEntryCommentsView(r),p.project_todo_lists=new n.TodoListsView(r),p.project_todo_list=new n.TodoListView(r),p.project_todo_item=new n.TodoItemView(r),p.project_todo_item_comments=new n.TodoItemCommentsView(r),_.on("route",function(t,o){var i,n;if(e.contains(["projects","companies","people","time_report","todos"],t))p.current=p[t].render();else if(e.contains(["project_people","project_categories","project_time_entries","project_posts","project_files","project_calendar","project_todo_lists"],t))i=parseInt(o[0],10),d(i,l.projects,p[t]),p[t].collection=l[t].get_or_create(i),p.current=p[t].render();else if(e.contains(["project_person","project_post","project_file","project_calendar_entry","project_category","project_todo_list","project_calendar_entry_comments","project_post_comments","todo_time_entries"],t)){switch(i=parseInt(o[0],10),n=parseInt(o[1],10),d(i,l.projects,p[t]),p[t].cur_item=n,t){case"project_person":p[t].collection=l.project_people.get_or_create(i);break;case"project_calendar_entry":p[t].collection=l.project_calendar.get_or_create(i);break;case"project_category":p[t].collection=l.project_categories.get_or_create(i);break;case"project_post":case"project_file":case"project_todo_list":p[t].collection=l[t+"s"].get_or_create(i);break;default:p[t].collection=l[t].get_or_create(n)}p.current=p[t].render()}}).on("route:project_todo_item",function(e,t,o){d(e,l.projects,p.project_todo_item),p.project_todo_item.cur_item=t,p.project_todo_item.todo_item=o,p.project_todo_item.collection=p.project_todo_item.todo_lists=l.project_todo_lists.get_or_create(e),p.current=p.project_todo_item.render()}).on("route:project_todo_item_comments",function(e,t,o){d(e,l.projects,p.project_todo_item_comments),p.project_todo_item_comments.cur_item=t,p.project_todo_item_comments.todo_item=o,p.project_todo_item_comments.todo_lists=l.project_todo_lists.get_or_create(e),p.project_todo_item_comments.collection=l.project_todo_item_comments.get_or_create(o),p.current=p.project_todo_item_comments.render()}).on("route:project",function(e){d(e,l.projects,p.project_view),p.current=p.project_view.render()}).on("route:company",function(e){d(e,l.companies,p.company_view),p.current=p.company_view.render()}).on("route:person",function(e){d(e,l.people,p.person_view),p.current=p.person_view.render()}).on("route:me",function(){p.person_view.model=c.mydata,p.current=p.person_view.render()}).on("route:defaultRoute",function(){this.navigate("projects",{trigger:!0})}),p.navbar=new n.NavView({model:c.mydata,el:".navbar"}).render(),c.mydata.once("sync",function(){t.history.start()}),c.mydata.fetch(),{models:c,collections:l,views:p,workspace:_}}});var BB=window.BB=new Backbone.Marionette.Application;Backbone.Marionette.TemplateCache.prototype.loadTemplate=function(e){var t=window.bbtemplates[e];return t&&0!==t.length||throwError("Could not find template: '"+e+"'","NoTemplateError"),t},BB.collections={},BB.views={},BB.addRegions({navRegion:"#navbar",headerRegion:"#header",mainRegion:"#content"}),BB.module("Projects",function(e,t,o,i,n,r){e.Model=o.Model.extend({urlRoot:"/api/projects/",icon:function(){switch(this.get("status")){case"active":return"icon-play";case"archived":return"icon-stop";case"on_hold":return"icon-pause"}}}),e.Collection=o.Collection.extend({url:"/api/projects.xml",model:e.Model}),e.ItemView=i.ItemView.extend({tagName:"li",template:"#oneproject"}),e.EmptyView=i.ItemView.extend({template:"#emptyprojects"}),e.View=i.CompositeView.extend({id:"projects",template:"#projects",itemView:e.ItemView,emptyView:e.EmptyView,templateHelpers:function(){return{view:this}},name:function(){return"Projects"},appendHtml:function(e,t){if(t.model.get("company")){var o=t.model.get("company").id,i=t.model.get("status"),n="#projects_"+i+"_"+o+" ul";e.$(n).append(t.el)}else e.$el.append(t.el)},initialize:function(){this.collection.bind("sync",this.render,this)}}),e.Header=i.View.extend({className:"page-header",template:"#header1",render:function(){return this.$el.html(r.template(window.bbtemplates[this.template],this.name(),{variable:"name"})),this},name:function(){return"Projects"}}),t.on("initialize:before",function(){t.collections.projects=new e.Collection,t.views.projectsView=new e.View({collection:t.collections.projects}),t.views.projectsHeader=new e.Header({collection:t.collections.projects})})}),BB.module("Companies",function(e,t,o,i,n,r){e.Model=o.Model.extend({urlRoot:"/api/companies/"}),e.Collection=o.Collection.extend({url:"/api/companies.xml",model:e.Model}),e.ItemView=i.ItemView.extend({tagName:"li",template:"#onecompany"}),e.EmptyView=i.ItemView.extend({tagName:"li",template:"#emptycompanies"}),e.View=i.CompositeView.extend({tagName:"ul",id:"companies",className:"unstyled",template:"#companies",itemView:e.ItemView,emptyView:e.EmptyView,name:function(){return"Companies"},appendHtml:function(e,t){e.$el.append(t.el)},initialize:function(){this.collection.bind("sync",this.render,this)}}),e.Header=i.View.extend({className:"page-header",template:"#header1",render:function(){return this.$el.html(r.template(window.bbtemplates[this.template],this.name(),{variable:"name"})),this},name:function(){return"Companies"}}),t.on("initialize:before",function(){t.collections.companies=new e.Collection,t.views.companiesView=new e.View({collection:t.collections.companies}),t.views.companiesHeader=new e.Header({collection:t.collections.companies})})}),BB.module("People",function(e,t,o,i,n,r){e.Model=o.Model.extend({urlRoot:"/api/people/",name:function(){return this.get("first-name")+" "+this.get("last-name")}}),e.Collection=o.Collection.extend({parent_id:null,url:function(){return this.parent_id?"/api/projects/"+this.parent_id+"/people.xml":"/api/people.xml"},model:e.Model}),e.ItemView=i.ItemView.extend({templateHelpers:function(){return{item:this.model}},tagName:"li",className:"media well well-small",template:"#personitem"}),e.EmptyView=i.ItemView.extend({template:"#emptypeople"}),e.View=i.CompositeView.extend({id:"people",template:"#people",itemView:e.ItemView,emptyView:e.EmptyView,templateHelpers:function(){return{view:this}},appendHtml:function(e,t){if(t.model.get("company")){var o=t.model.get("company").id,i="#people_c"+o+" ul.media-list";e.$(i).length?e.$(i).append(t.el):e.$("ul.media-list").append(t.el)}else e.$el.append(t.el)},initialize:function(){this.collection.bind("sync",this.render,this)}}),e.Header=i.View.extend({className:"page-header",template:"#header1",render:function(){return this.$el.html(r.template(window.bbtemplates[this.template],this.name(),{variable:"name"})),this},name:function(){return"People"}}),e.PersonView=i.ItemView.extend({templateHelpers:function(){return{item:this.model}},template:"#person"}),e.PersonHeader=i.View.extend({className:"page-header",template:"#header1",render:function(){return this.$el.html(r.template(window.bbtemplates[this.template],this.name(),{variable:"name"})),this},name:function(){return this.model.name()}}),t.on("initialize:before",function(){t.collections.people=new e.Collection,t.views.peopleView=new e.View({collection:t.collections.people}),t.views.peopleHeader=new e.Header({collection:t.collections.people}),t.views.personView=new e.PersonView({model:new e.Model}),t.views.personHeader=new e.PersonHeader({model:new e.Model})})}),BB.module("Time",function(e,t,o,i,n,r){e.Model=o.Model.extend({urlRoot:"/api/time_entries/"}),e.Collection=o.PageableCollection.extend({mode:"client",parent_id:null,parent:"projects",filter_report:null,url:function(){return r.isFinite(this.parent_id)?"/api/"+this.parent+"/"+this.parent_id+"/time_entries.xml":this.filter_report?"/api/time_entries/report.xml?"+this.filter_report:"/api/time_entries/report.xml"},model:e.Model}),e.ItemView=i.ItemView.extend({templateHelpers:function(){return{item:this.model}},tagName:"tr",className:function(){return this.model.get("hours")>2?"warning":void 0},template:"#time"}),e.EmptyView=i.ItemView.extend({template:"#emptytime"}),e.View=i.CompositeView.extend({id:"time-report",template:"#time-report",itemView:e.ItemView,emptyView:e.EmptyView,pagerid:"time-report",events:{"click .time-report.previous":"previous","click .time-report.next":"next","click #getreport":"getreport"},previous:function(e){return e.preventDefault(),this.collection.hasPrevious()&&this.collection.getPreviousPage()&&this.render()},next:function(e){return e.preventDefault(),this.collection.hasNext()&&this.collection.getNextPage()&&this.render()},getreport:function(e){e.preventDefault(),this.collection.filter_report=n.param(r.filter(this.$("form#makereport").serializeArray(),function(e){return e.value})),this.collection.fetch({cache:!0})},renderpager:function(){return r.template(window.bbtemplates["#pager"],this,{variable:"view"})},templateHelpers:function(){return{view:this}},appendHtml:function(e,t){if(r.isFinite(t.model.get("project-id"))){var o=t.model.get("project-id"),i="#times_p"+o;e.$(i).after(t.el)}else e.$el.append(t.el)},initialize:function(){this.collection.bind("sync",this.render,this)}}),e.Header=i.View.extend({className:"page-header",template:"#header1",render:function(){return this.$el.html(r.template(window.bbtemplates[this.template],this.name(),{variable:"name"})),this},name:function(){return"Time report"}}),t.on("initialize:before",function(){t.collections.times=new e.Collection,t.views.timesView=new e.View({collection:t.collections.times}),t.views.timesHeader=new e.Header({collection:t.collections.times})})}),BB.module("Todo",function(e,t,o,i,n,r){e.Model=o.Model.extend({urlRoot:"/api/todo_items/",complete:function(){this.save("completed",!0,{url:r.result(this,"url").replace(".xml","/complete.xml")})},uncomplete:function(){this.save("completed",!1,{url:r.result(this,"url").replace(".xml","/uncomplete.xml")})}}),e.Collection=o.Collection.extend({responsible_party:null,parent_id:null,filter_status:null,url:function(){return r.isFinite(this.parent_id)&&this.filter_status?"/api/projects/"+this.parent_id+"/todo_lists.xml?filter="+this.filter_status:r.isFinite(this.parent_id)?"/api/projects/"+this.parent_id+"/todo_lists.xml":null===this.responsible_party?"/api/todo_lists.xml":""===this.responsible_party?"/api/todo_lists.xml?responsible_party=":"/api/todo_lists.xml?responsible_party="+this.responsible_party},model:e.Model}),e.ItemView=i.ItemView.extend({templateHelpers:function(){return{list:this.model}},tagName:"dl",template:"#todolist"}),e.EmptyView=i.ItemView.extend({tagName:"li",template:"#emptytodos"}),e.View=i.CompositeView.extend({tagName:"ul",id:"todos",className:"unstyled",template:"#todo-lists",itemView:e.ItemView,emptyView:e.EmptyView,events:{"change select[name='target']":"selectTarget"},selectTarget:function(e){console.log("selectTarget"),this.collection.responsible_party=n(e.target).val(),this.collection.fetch({cache:!0})},templateHelpers:function(){return{view:this}},appendHtml:function(e,t){if(r.isFinite(t.model.get("project-id"))){var o=t.model.get("project-id"),i="#todos_p"+o;e.$(i).append(t.el)}else e.$el.append(t.el)},initialize:function(){this.collection.bind("sync",this.render,this)},description:function(){if(this.collection.responsible_party){var e=t.collections.people&&t.collections.people.get(this.collection.responsible_party);return e?e.name()+"'s":this.collection.responsible_party+"'s"}return null===this.collection.responsible_party?"My":""===this.collection.responsible_party?"Unassigned":"All"}}),e.Header=i.View.extend({className:"page-header",template:"#header1",render:function(){return this.$el.html(r.template(window.bbtemplates[this.template],this.name(),{variable:"name"})),this},name:function(){if(this.collection.responsible_party){var e=t.collections.people&&t.collections.people.get(this.collection.responsible_party);return e?e.name()+"'s to-dos":this.collection.responsible_party+"'s to-dos"}return null===this.collection.responsible_party?"My to-dos":""===this.collection.responsible_party?"Unassigned to-dos":"To-dos"}}),t.on("initialize:before",function(){t.collections.todos=new e.Collection,t.views.todosView=new e.View({collection:t.collections.todos}),t.views.todosHeader=new e.Header({collection:t.collections.todos})})}),BB.module("Base",function(e,t,o,i,n,r){e.Me=t.People.Model.extend({url:"/api/me.xml"}),e.NavBarView=i.View.extend({template:"#nav",className:"navbar-inner",render:function(){return this.$el.html(r.template(window.bbtemplates[this.template],this,{variable:"view"})),this},initialize:function(){this.model.bind("change",this.render,this)}}),t.on("initialize:before",function(){t.me=new e.Me;var o=new e.NavBarView({model:t.me});t.navRegion.show(o)})}),BB.addInitializer(function(){BB.me.fetch(),BB.collections.projects.fetch(),BB.collections.companies.fetch(),BB.collections.people.fetch(),BB.collections.times.fetch(),BB.collections.todos.fetch()});var Workspace=Backbone.Router.extend({routes:{projects:"projects","projects:tab":"projects","projects/:id":"project","projects/:id/todo_lists":"project_todo_lists","projects/:id/todo_lists/:tlid":"project_todo_list","projects/:id/todo_lists/:tlid/:tiid":"project_todo_item","projects/:id/todo_lists/:tlid/:tiid/comments":"project_todo_item_comments","projects/:id/time_entries/todo_items/:tiid":"todo_time_entries","projects/:id/time_entries":"project_time_entries","projects/:id/people":"project_people","projects/:id/posts":"project_posts","projects/:id/posts/:pid":"project_post","projects/:id/posts/:pid/comments":"project_post_comments","projects/:id/files":"project_files","projects/:id/files/:fid":"project_file","projects/:id/calendar":"project_calendar","projects/:id/calendar/:cid":"project_calendar_entry","projects/:id/calendar/:cid/comments":"project_calendar_entry_comments","projects/:id/categories":"project_categories","projects/:id/categories/:cid":"project_category",companies:"companies","companies/:id":"company",people:"people","people:tab":"people","people/:id":"person",me:"me",todos:"todos",time_report:"time_report","*actions":"defaultRoute"}}),workspace=new Workspace;workspace.on("route",function(e,t){console.log(e,t)}).on("route:projects",function(){BB.headerRegion.show(BB.views.projectsHeader),BB.mainRegion.show(BB.views.projectsView)}).on("route:companies",function(){BB.headerRegion.show(BB.views.companiesHeader),BB.mainRegion.show(BB.views.companiesView)}).on("route:people",function(){BB.headerRegion.show(BB.views.peopleHeader),BB.mainRegion.show(BB.views.peopleView)}).on("route:time_report",function(){BB.headerRegion.show(BB.views.timesHeader),BB.mainRegion.show(BB.views.timesView)}).on("route:todos",function(){BB.headerRegion.show(BB.views.todosHeader),BB.mainRegion.show(BB.views.todosView)}).on("route:me",function(){BB.views.personHeader.model=BB.me,BB.views.personView.model=BB.me,BB.headerRegion.show(BB.views.personHeader),BB.mainRegion.show(BB.views.personView)}).on("route:person",function(e){BB.views.personHeader.model=BB.collections.people.get(e),BB.views.personView.model=BB.collections.people.get(e),BB.headerRegion.show(BB.views.personHeader),BB.mainRegion.show(BB.views.personView)}).on("route:defaultRoute",function(){this.navigate("projects",{trigger:!0})}),BB.on("initialize:after",function(){Backbone.history&&Backbone.history.start()}),$(document).ready(function(){BB.start()});