!function(e,t){"use strict";"function"==typeof e.define&&e.define.amd?e.define("bbviews",["underscore","backbone","bbtemplates","bootstrap","jquerydeserialize","backbonecache"],t):e.bbviews=t(e._,e.Backbone,e.bbtemplates)}(this,function(e,t,i){"use strict";var o={},n="Companies",s="#"+n.toLowerCase(),r=[s,n],c="Projects",l="#"+c.toLowerCase(),a=[l,c],p=function(e){e.preventDefault(),this.currentTarget(e).edit=!0,this.render()},d=function(e){e.preventDefault(),this.currentTarget(e).edit=!1,this.render()},m=function(e){e.preventDefault(),this.currentTarget(e).destroy(),this.render()},h=function(e){e.preventDefault();var t=this.currentTarget(e);t.edit=!1,t.save(this.parseData(e.currentTarget)),this.render()},u={edititem:p,removeitem:m,resetitem:d},f={"click .reset":"resetitem","click .save":"saveitem"},v={"click #pages":"switch_pages","click .next":"next","click .previous":"previous"},g=e.extend(f,e.extend(v,{"click .edit":"edititem","click .remove":"removeitem","click thead>tr>th":"sortitems"})),_=e.extend(f,{"click .todo.uncompleteitem":"uncomplete","click .todo.edititem":"edititem","click .todo.completeitem":"complete"}),y=e.result,x=t.$,w=function(t,o,n){return e.template(i[t],o,n)},j=t.View.extend({deps:function(){return this.collection?[this.collection]:[]},fetch:function(){var e,t=this.deps();for(e in t)if(t.hasOwnProperty(e)&&!t[e].fetchonce())break},title:function(){return this.model.name()},name:function(){var t=this.Path();return t?e.pluck(t,1).reverse().join(" - "):y(this,"title")},Path:function(){var e=y(this,"path");return e&&e.push(["",y(this,"title")]),e},PageTitle:function(){return y(this,"name")+" - BB"},PageHeader:function(){return y(this,"title")||y(this,"name")},render:function(){return this.$el.html(w(this.template,{view:this})),this.delegateEvents(),this.PageTitle&&(document.title=this.PageTitle()),x(e.filter(x("ul.projectnav li").removeClass("active"),function(e){return x(e).find("a:visible")[0]&&-1!==document.location.hash.indexOf(x(e).find("a:visible")[0].hash)})).filter(":last").addClass("active"),this.fetch(),this},itemblock:function(e,t){return w(e.edit?t+"edit":t,{item:e,view:this})},block:function(e){return w(e,{view:this})}}),P=j.extend({deps:function(){return[this.collection,this.options.collections.projects]},path:function(){return[r,[s+"/"+(this.model.get("company")&&this.model.get("company").id),this.model.get("company")&&this.model.get("company").name],a,[l+"/"+this.model.id,this.model.name()]]}}),T=P.extend({events:v,switch_pages:function(e){return e.preventDefault(),this.collection.state.pageSize>25?this.collection.setPageSize(25,{first:!0}):this.collection.setPageSize(1e9)},previous:function(e){return e.preventDefault(),this.collection.hasPrevious()&&this.collection.getPreviousPage()},next:function(e){return e.preventDefault(),this.collection.hasNext()&&this.collection.getNextPage()}}),b=P.extend({cur_item:null,title:function(){return y(this,"itemtitle")},itemtitle:function(){var t=e.isFinite(this.cur_item)?this.collection.get(this.cur_item):this.cur_item;return t&&t.name()},nameParent:"",basepath:function(){var e=P.prototype.path.apply(this);return e.push([l+"/"+this.model.id+"/"+(this.idParent||this.nameParent.toLowerCase()),this.nameParent]),e},extrapath:[],path:function(){var t=y(this,"basepath");return e.each(y(this,"extrapath"),function(e){t.push(e)}),t}});return o.AllPeopleView=j.extend({deps:function(){return[this.collection,this.options.collections.companies]},template:"#people",title:"People"}),o.ProjectsView=j.extend({template:l,title:c}),o.ProjectView=j.extend({deps:function(){return[this.options.collections.projects]},path:function(){return P.prototype.path.apply(this).slice(0,-1)},template:"#project"}),o.CompaniesView=j.extend({template:s,title:n}),o.CompanyView=j.extend({deps:function(){return[this.options.collections.companies,this.options.collections.projects,this.options.collections.people]},path:function(){return[r]},template:"#company"}),o.PeopleView=P.extend({deps:function(){return[this.collection,this.options.collections.projects,this.options.collections.companies]},template:"#project-people",title:"People"}),o.PersonView=b.extend({template:"#project-person",nameParent:"People"}),o.TimeEntriesView=T.extend({deps:function(){return[this.collection,this.options.collections.projects,this.options.collections.people]},pagerid:"project-time",events:e.extend(g,{"click .add":"additem"}),parseData:function(e){var t=this.$(e).parents(".form");return{date:t.find("[name=date]").val(),description:t.find("[name=description]").val(),hours:parseFloat(t.find("[name=hours]").val(),10),"person-id":parseInt(t.find("[name=person-id]").val(),10)}},finishItem:function(e){return e.set({"person-name":this.options.collections.people.get(e.get("person-id")).name(),"project-id":this.model.id},{silent:!0}),this.collection.fullCollection.comparator||this.collection.setSorting("id",1),this.collection.fullCollection.sort(),this.render(),!0},sortitems:function(e){e.preventDefault();var t=x(e.currentTarget).data("sort")||x(e.currentTarget).text();this.collection.setSorting(t,-this.collection.state.order),this.collection.fullCollection.sort()},additem:function(e){e.preventDefault();var t=this,i=function(e){return t.finishItem(e)};this.collection.create(this.parseData(e.currentTarget),{wait:!0,success:i})},currentTarget:function(e){return this.collection.get(x(e.currentTarget).parents("tr").data("id"))},saveitem:h,template:"#project-time",title:"Time"}).extend(u),o.TodoTimeEntriesView=o.TimeEntriesView.extend({pagerid:"todo-time",finishItem:function(e){return e.set({"person-name":this.options.collections.people.get(e.get("person-id")).name(),"project-id":this.model.id,"todo-item-id":this.cur_item},{silent:!0})},template:"#todo-time"}),o.TimeReportView=o.TimeEntriesView.extend({deps:function(){return[this.collection,this.options.collections.projects,this.options.collections.people,this.options.collections.companies]},pagerid:"time-report",events:e.extend(g,{"click #getreport":"getreport"}),getreport_filter:function(){return e.object(e.pluck(this.collection.filter_report,"name"),e.pluck(this.collection.filter_report,"value"))},getreport:function(t){t.preventDefault(),this.collection.filter_report=e.filter(this.$("form#makereport").serializeArray(),function(e){return e.value}),this.collection.fetch({cache:!0,reset:!0})},template:"#time-report",path:!1,title:"Time report"}),o.PostCommentsView=b.extend({deps:function(){return[this.collection,this.options.collections.projects,this.options.collections.project_posts.get_or_create(this.model.id)]},template:"#project-post-comments",extrapath:function(){return[[l+"/"+this.model.id+"/"+(this.idParent||this.nameParent.toLowerCase())+"/"+this.cur_item,y(this,"itemname")]]},nameParent:"Posts",itemname:function(){var t=e.isFinite(this.cur_item)&&this.options.collections.project_posts.get_or_create(this.model.id).get(this.cur_item),i=t&&t.name();return i},title:"Comments"}),o.CalendarEntryCommentsView=o.PostCommentsView.extend({deps:function(){return[this.collection,this.options.collections.projects,this.options.collections.project_calendar.get_or_create(this.model.id)]},template:"#project-calendar-entry-comments",nameParent:"Calendar",itemname:function(){var t=e.isFinite(this.cur_item)&&this.options.collections.project_calendar.get_or_create(this.model.id).get(this.cur_item),i=t&&t.name();return i}}),o.PostsView=P.extend({template:"#project-posts",title:"Posts"}),o.PostView=b.extend({template:"#project-post",nameParent:"Posts"}),o.FilesView=T.extend({deps:function(){return[this.collection,this.options.collections.projects,this.options.collections.people,this.options.collections.project_categories.get_or_create(this.model.id)]},pagerid:"project-files",template:"#project-files",title:"Files"}),o.FileView=b.extend({deps:o.FilesView.prototype.deps,template:"#project-file",nameParent:"Files"}),o.CalendarView=P.extend({events:e.extend(f,{"click .uncompleteitem":"uncomplete","click .edititem":"edititem","click .removeitem":"removeitem","click .completeitem":"complete"}),parseData:function(e){var t=this.$(e).parents(".form");return{deadline:t.find("[name=deadline]").val(),"start-at":t.find("[name=start-at]").val(),title:t.find("[name=title]").val(),type:t.find("[name=type]").val()}},finishItem:function(e){return e.set({"project-id":this.model.id},{silent:!0})},complete:function(e){e.preventDefault(),this.currentTarget(e).complete(),this.render()},uncomplete:function(e){e.preventDefault(),this.currentTarget(e).uncomplete(),this.render()},currentTarget:function(e){return this.collection.get(x(e.currentTarget).data("id"))},saveitem:h,template:"#project-calendar",title:"Calendar"}).extend(u),o.CalendarEntryView=b.extend({template:"#project-calendar-entry",nameParent:"Calendar"}),o.CategoriesView=T.extend({pagerid:"project-categories",template:"#project-categories",title:"Categories"}),o.CategoryView=b.extend({template:"#project-category",nameParent:"Categories"}),o.AllPersonView=j.extend({deps:function(){return[this.options.collections.people,this.options.collections.companies]},template:"#person",path:function(){return[["#people","People"]]}}),o.TodosView=j.extend({cur_item:1,deps:o.TimeEntriesView.prototype.deps,events:{"click .todo-lists.completeitem":"complete","change select[name=target]":"selectTarget"},complete:function(t){t.preventDefault();var i=x(t.currentTarget),o=i.data("id"),n=new this.options.collections.todo_items.model({id:o}),s=i.data("todolistId"),r=this.collection.get(s),c=e.where(r.get("todo-items"),{id:o});n.complete(),e.each(c,function(e){e.completed=!0}),this.render()},selectTarget:function(e){this.collection.responsible_party=x(e.target).val(),this.collection.fetch({cache:!0,reset:!0})},template:"#todo-lists",title:function(){if(this.collection.responsible_party){var e=this.options.collections.people&&this.options.collections.people.get(this.collection.responsible_party);return e?e.name()+"'s to-dos":this.collection.responsible_party+"'s to-dos"}return null===this.collection.responsible_party?"My to-dos":""===this.collection.responsible_party?"Unassigned to-dos":"To-dos"},description:function(){if(this.collection.responsible_party){var e=this.options.collections.people&&this.options.collections.people.get(this.collection.responsible_party);return e?e.name()+"'s":this.collection.responsible_party+"'s"}return null===this.collection.responsible_party?"My":""===this.collection.responsible_party?"Unassigned":"All"}}),o.TodoListsView=P.extend({template:"#project-todo-lists",events:e.extend(f,{"click .add_todolist .add":"additem","click .todolist.edititem":"edititem","click .todolist.removeitem":"removeitem"}),finishItem:function(e){return e.set({"project-id":this.model.id},{silent:!0}),this.render(),!0},currentTarget:o.CalendarView.prototype.currentTarget,saveitem:h,parseData:function(e){var t=this.$(e).parents(".form");return{description:t.find("[name=description]").val(),name:t.find("[name=name]").val(),"private":t.find("[name=private]").is(":checked"),tracked:t.find("[name=tracked]").is(":checked")}},additem:o.TimeEntriesView.prototype.additem,title:"To-dos"}).extend(u),o.TodoListView=b.extend({deps:function(){return[this.collection,this.options.collections.projects,this.todos(),this.options.collections.project_people.get_or_create(this.model.id)]},events:e.extend(_,{"click .add_todo .add":"additem","click .todo.removeitem":"removeitem"}),todos:function(){return this.options.collections.todo_items.get_or_create(this.cur_item)},parseData:function(e){var t=this.$(e).parents(".form");return{content:t.find("[name=content]").val(),"due-at":t.find("[name=due-at]").val(),notify:t.find("[name=notify]").is(":checked"),"responsible-party":t.find("[name=responsible-party]").val()}},currentTarget:function(e){return this.todos().get(x(e.currentTarget).data("id"))},saveitem:h,complete:o.CalendarView.prototype.complete,uncomplete:o.CalendarView.prototype.uncomplete,finishItem:function(t){var i={"comments-count":0,completed:!1,"project-id":this.model.id,"todo-list-id":this.cur_item};return i=e.isFinite(t.get("responsible-party"))?e.extend(i,{"responsible-party-id":parseInt(t.get("responsible-party"),10),"responsible-party-name":this.options.collections.project_people.get_or_create(this.model.id).get(t.get("responsible-party")).name(),"responsible-party-type":"Person"}):e.extend(i,{"responsible-party-id":void 0,"responsible-party-name":void 0,"responsible-party-type":void 0}),t.set(i,{silent:!0}),this.render(),!0},additem:function(e){e.preventDefault();var t=this,i=function(e){return t.finishItem(e)};this.todos().create(this.parseData(e.currentTarget),{wait:!0,success:i})},template:"#project-todo-list",idParent:"todo_lists",nameParent:"To-dos"}).extend(u),o.TodoItemView=o.TodoListView.extend({todo_item:null,deps:function(){return[this.collection,this.options.collections.projects,this.todo_lists,this.todos()]},events:_,currentTarget:function(){return this.todos().get(this.todo_item)},template:"#project-todo-item",extrapath:o.PostCommentsView.prototype.extrapath,itemname:function(){var e=this.cur_item&&this.todo_lists.get(this.cur_item),t=e&&e.name();return t},itemtitle:function(){var t=e.isFinite(this.todo_item)?this.todos().get(this.todo_item):this.todo_item,i=t&&t.name();return i}}),o.TodoItemCommentsView=o.TodoItemView.extend({template:"#project-todo-item-comments",extrapath:function(){var e=o.TodoItemView.prototype.extrapath.apply(this);return[e.shift(),[l+"/"+this.model.id+"/"+(this.idParent||this.nameParent.toLowerCase())+"/"+this.cur_item+"/"+this.todo_item,y(this,"itemtitle")]]},title:"Comments"}),o.NavView=j.extend({navitems:{projects:"Projects",companies:"Companies",todos:"To-Dos",time_report:"Time",people:"People"},dropdownitems:{me:{icon:"user",title:"My profile"},todos:{icon:"tasks",title:"My todos"},time_report:{icon:"time",title:"My time"}},template:"#nav",initialize:function(){this.model.bind("change",this.render,this),t.history.on("route",function(){x(e.filter(x(".navbar ul.nav li").removeClass("active"),function(e){return x(e).find("a:visible")[0]&&-1!==document.location.hash.indexOf(x(e).find("a:visible")[0].hash)})).addClass("active")},this)}}),o});
//# sourceMappingURL=app/static/js/views.min.js.map