!function(e,t){"use strict";if(typeof e.define==="function"&&e.define.amd){e.define("bbviews",["jquery","underscore","backbone","bbtemplates","bootstrap","jquerydeserialize","backbonecache"],t)}else{e.bbviews=t(e.jQuery,e._,e.Backbone,e.bbtemplates)}}(this,function(e,t,i,o){"use strict";var n={},r="Companies",s="#"+r.toLowerCase(),c=[s,r],l="Projects",a="#"+l.toLowerCase(),p=[a,l],m=function(e,i,n){return t.template(o[e],i,n)},h=i.View.extend({deps:function(){return this.collection.fetchonce()},title:function(){return this.model.name()},name:function(){var e=this.Path();return e?t.pluck(e,1).reverse().join(" - "):t.result(this,"title")},Path:function(){var e=t.result(this,"path");if(e){e.push(["",t.result(this,"title")])}return e},PageTitle:function(){return t.result(this,"name")+" - BB"},PageHeader:function(){return t.result(this,"title")||t.result(this,"name")},render:function(){this.$el.html(m(this.template,this,{variable:"view"}));return this},renderitem:function(e){return m(e.edit?this.itemtemplate+"edit":this.itemtemplate,e,{variable:"item"})},rendercomments:function(e){return m("#comments-template",e,{variable:"comments"})},renderpager:function(){return m("#pager-template",this,{variable:"view"})},renderheader:function(){return m("#header-template",this,{variable:"view"})},renderprojectnav:function(){return m("#project-nav-template",this,{variable:"view"})}}),d=h.extend({deps:function(){return this.collection.fetchonce()&&this.options.collections.projects.fetchonce()},path:function(){return[c,[s+"/"+(this.model.get("company")&&this.model.get("company").id),this.model.get("company")&&this.model.get("company").name],p,[a+"/"+this.model.id,this.model.name()]]}}),u=d.extend({previous:function(e){e.preventDefault();return this.collection.hasPrevious()&&this.collection.getPreviousPage()},next:function(e){e.preventDefault();return this.collection.hasNext()&&this.collection.getNextPage()}}),f=d.extend({cur_item:null,title:function(){return t.result(this,"itemtitle")},itemtitle:function(){var e=t.isFinite(this.cur_item)?this.collection.get(this.cur_item):this.cur_item;return e&&e.name()},nameParent:"",basepath:function(){var e=d.prototype.path.apply(this,arguments);e.push([a+"/"+this.model.id+"/"+(this.idParent||this.nameParent.toLowerCase()),this.nameParent]);return e},extrapath:function(){return[]},path:function(){var e=this.basepath(),t=this.extrapath();t.forEach(function(t){return e.push(t)});return e}}),v=h.prototype;n.AllPeopleView=h.extend({deps:function(){return this.collection.fetchonce()&&this.options.collections.companies.fetchonce()},template:"#people-template",itemtemplate:"#personitem-template",title:"People"});n.ProjectsView=h.extend({template:a+"-template",title:l});n.ProjectView=h.extend({deps:function(){return this.options.collections.projects.fetchonce()},path:function(){return d.prototype.path.apply(this,arguments).slice(0,-1)},template:"#project-template"});n.CompaniesView=h.extend({template:s+"-template",title:r});n.CompanyView=h.extend({deps:function(){return this.options.collections.companies.fetchonce()&&this.options.collections.projects.fetchonce()&&this.options.collections.people.fetchonce()},path:function(){return[c]},template:"#company-template"});n.PeopleView=d.extend({deps:function(){return this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.options.collections.companies.fetchonce()},template:"#project-people-template",itemtemplate:"#personitem-template",title:"People"});n.TimeEntriesView=u.extend({deps:function(){return this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.options.collections.people.fetchonce()},pagerid:"project-time",events:{"click .project-time.previous":"previous","click .project-time.next":"next","click .project-time #add":"addtime","click .project-time #edit":"edittime","click .project-time #remove":"removetime","click .project-time #save":"savetime","click .project-time #reset":"resettime","click .project-time thead>tr>th":"sorttime"},parseData:function(e){var t={};t.date=this.$(e+" [name=date]").val();t.description=this.$(e+" [name=description]").val();t.hours=parseFloat(this.$(e+" [name=hours]").val(),10);t["person-id"]=parseInt(this.$(e+" [name=person-id]").val(),10);return t},finishItem:function(e){e.set("project-id",this.model.id,{silent:true});e.set("person-name",this.options.collections.people.get(e.get("person-id")).name(),{silent:true});return e},sorttime:function(t){t.preventDefault();var i=e(t.currentTarget).data("sort")||e(t.currentTarget).text();this.collection.setSorting(i,-this.collection.state.order);this.collection.fullCollection.sort()},addtime:function(e){e.preventDefault();var t=this;this.collection.create(this.parseData(".addtime"),{wait:true,success:function(e){t.finishItem(e);try{t.collection.fullCollection.sort()}catch(i){t.collection.setSorting("id",1);t.collection.fullCollection.sort()}return true}});this.render()},edittime:function(t){t.preventDefault();var i=e(t.currentTarget).parents("tr").data("id"),o=this.collection.get(i);o.edit=true;this.render()},resettime:function(t){t.preventDefault();var i=e(t.currentTarget).parents("tr").data("id"),o=this.collection.get(i);o.edit=false;this.render()},removetime:function(t){t.preventDefault();var i=e(t.currentTarget).parents("tr").data("id"),o=this.collection.get(i);o.destroy();this.render()},savetime:function(t){t.preventDefault();var i=e(t.currentTarget).parents("tr").data("id"),o=this.collection.get(i);o.edit=false;o.save(this.parseData(".edittime[data-id="+i+"]"));this.render()},itemtemplate:"#time-template",template:"#project-time-template",title:"Time"});n.TodoTimeEntriesView=n.TimeEntriesView.extend({pagerid:"todo-time",events:{"click .todo-time.previous":"previous","click .todo-time.next":"next","click .todo-time #add":"addtime","click .todo-time #edit":"edittime","click .todo-time #remove":"removetime","click .todo-time #save":"savetime","click .todo-time #reset":"resettime","click .todo-time thead>tr>th":"sorttime"},finishItem:function(e){e.set("project-id",this.model.id,{silent:true});e.set("todo-item-id",this.cur_item,{silent:true});e.set("person-name",this.options.collections.people.get(e.get("person-id")).name(),{silent:true});return e},template:"#todo-time-template"});n.TimeReportView=n.TimeEntriesView.extend({deps:function(){return this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.options.collections.people.fetchonce()&&this.options.collections.companies.fetchonce()},pagerid:"time-report",events:{"click .time-report.previous":"previous","click .time-report.next":"next","click #getreport":"getreport","click .time-report #edit":"edittime","click .time-report #remove":"removetime","click .time-report #save":"savetime","click .time-report #reset":"resettime","click .time-report thead>tr>th":"sorttime"},getreport:function(i){i.preventDefault();this.collection.filter_report=e.param(t.filter(this.$("form#makereport").serializeArray(),function(e){return e.value}));this.collection.fetch({cache:true,reset:true})},template:"#time-report-template",path:false,title:"Time report",render:function(){v.render.apply(this,arguments);if(this.collection.filter_report){this.$el.find("form#makereport").deserialize(this.collection.filter_report)}return this}});n.PostCommentsView=f.extend({deps:function(){return this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.options.collections.project_posts.get_or_create(this.model.id).fetchonce()},template:"#project-post-comments-template",itemtemplate:"#post-template",extrapath:function(){return[[a+"/"+this.model.id+"/"+(this.idParent||this.nameParent.toLowerCase())+"/"+this.cur_item,t.result(this,"itemname")]]},nameParent:"Posts",itemname:function(){var e=t.isFinite(this.cur_item)&&this.options.collections.project_posts.get_or_create(this.model.id).get(this.cur_item),i=e&&e.name();return i},title:"Comments"});n.CalendarEntryCommentsView=n.PostCommentsView.extend({deps:function(){return this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.options.collections.project_calendar.get_or_create(this.model.id).fetchonce()},template:"#project-calendar-entry-comments-template",itemtemplate:"#calendar-template",nameParent:"Calendar",itemname:function(){var e=t.isFinite(this.cur_item)&&this.options.collections.project_calendar.get_or_create(this.model.id).get(this.cur_item),i=e&&e.name();return i}});n.PostsView=d.extend({template:"#project-posts-template",itemtemplate:"#post-template",title:"Posts"});n.PostView=f.extend({template:"#project-post-template",itemtemplate:"#post-template",nameParent:"Posts"});n.FilesView=u.extend({deps:function(){return this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.options.collections.people.fetchonce()&&this.options.collections.project_categories.get_or_create(this.model.id).fetchonce()},pagerid:"project-files",events:{"click .project-files.previous":"previous","click .project-files.next":"next"},template:"#project-files-template",title:"Files"});n.FileView=f.extend({deps:function(){return this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.options.collections.people.fetchonce()&&this.options.collections.project_categories.get_or_create(this.model.id).fetchonce()},template:"#project-file-template",nameParent:"Files"});n.CalendarView=d.extend({template:"#project-calendar-template",itemtemplate:"#calendar-template",title:"Calendar"});n.CalendarEntryView=f.extend({template:"#project-calendar-entry-template",itemtemplate:"#calendar-template",nameParent:"Calendar"});n.CategoriesView=u.extend({pagerid:"project-categories",events:{"click .project-categories.previous":"previous","click .project-categories.next":"next"},template:"#project-categories-template",itemtemplate:"#category-template",title:"Categories"});n.CategoryView=f.extend({template:"#project-category-template",itemtemplate:"#category-template",nameParent:"Categories"});n.PersonView=h.extend({deps:function(){return this.options.collections.people.fetchonce()&&this.options.collections.companies.fetchonce()},template:"#person-template",path:function(){return[["#people","People"]]}});n.TodosView=h.extend({deps:function(){return this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.options.collections.people.fetchonce()},events:{"change select[name='target']":"selectTarget"},selectTarget:function(t){this.collection.responsible_party=e(t.target).val();this.collection.fetch({cache:true,reset:true})},template:"#todo-lists-template",itemtemplate:"#todolist-template",title:function(){if(this.collection.responsible_party){var e=this.options.collections.people&&this.options.collections.people.get(this.collection.responsible_party);return e?e.name()+"'s to-dos":this.collection.responsible_party+"'s to-dos"}if(this.collection.responsible_party===null){return"My to-dos"}if(this.collection.responsible_party===""){return"Unassigned to-dos"}return"To-dos"},description:function(){if(this.collection.responsible_party){var e=this.options.collections.people&&this.options.collections.people.get(this.collection.responsible_party);return e?e.name()+"'s":this.collection.responsible_party+"'s"}if(this.collection.responsible_party===null){return"My"}if(this.collection.responsible_party===""){return"Unassigned"}return"All"}});n.TodoListsView=d.extend({template:"#project-todo-lists-template",itemtemplate:"#todolist-template",title:"To-dos"});n.TodoListView=f.extend({deps:function(){return this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.options.collections.todo_items.get_or_create(this.cur_item).fetchonce()},template:"#project-todo-list-template",itemtemplate:"#todolist-template",idParent:"todo_lists",nameParent:"To-dos",render:function(){v.render.apply(this,arguments);if(t.isFinite(this.cur_item)){this.options.collections.todo_items.get_or_create(this.cur_item).each(function(e){this.$el.find(".todoitemsholder").append(this.options.todo(this.model.id,e).render().el)},this)}return this}});n.TodoItemView=f.extend({todo_item:null,deps:function(){return this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.todo_lists.fetchonce()&&this.options.collections.todo_items.get_or_create(this.cur_item).fetchonce()},template:"#project-todo-item-template",itemtemplate:"#todolist-template",extrapath:n.PostCommentsView.prototype.extrapath,idParent:"todo_lists",nameParent:"To-dos",title:function(){return t.result(this,"itemtitle")},itemname:function(){var e=this.cur_item&&this.todo_lists.get(this.cur_item),t=e&&e.name();return t},itemtitle:function(){var e=t.isFinite(this.todo_item)?this.options.collections.todo_items.get_or_create(this.cur_item).get(this.todo_item):this.todo_item,i=e&&e.name();return i},render:function(){v.render.apply(this,arguments);var e=this.options.collections.todo_items.get_or_create(this.cur_item).get(this.todo_item);if(e){this.$el.find(".todoitemsholder").append(this.options.todo(this.model.id,e).render().el)}return this}});n.TodoItemCommentsView=n.TodoItemView.extend({template:"#project-todo-item-comments-template",extrapath:function(){var e=n.TodoItemView.prototype.extrapath.apply(this,arguments);return[e.shift(),[a+"/"+this.model.id+"/"+(this.idParent||this.nameParent.toLowerCase())+"/"+this.cur_item+"/"+this.todo_item,t.result(this,"itemtitle")]]},title:"Comments"});n.TodoView=h.extend({events:{"click .todo.icon-completed":"uncomplete","click .todo.icon-uncompleted":"complete"},complete:function(){this.model.complete()},uncomplete:function(){this.model.uncomplete()},tagName:"dd",template:"#todo-template",render:function(){v.render.apply(this,arguments);this.delegateEvents();return this}});n.NavView=h.extend({template:"#nav-template",initialize:function(){this.model.bind("change",this.render,this)}});return n});