!function(e,t){"use strict";"function"==typeof e.define&&e.define.amd?e.define("bbviews",["jquery","underscore","backbone","bbtemplates","bootstrap","jquerydeserialize","backbonecache"],t):e.bbviews=t(e.jQuery,e._,e.Backbone,e.bbtemplates)}(this,function(e,t,o,i){"use strict";var n={},c="Companies",r="#"+c.toLowerCase(),s=[r,c],l="Projects",p="#"+l.toLowerCase(),a=[p,l],m=t.result,d=function(e,o,n){return t.template(i[e],o,n)},h=o.View.extend({deps:function(){return this.collection.fetchonce()},title:function(){return this.model.name()},name:function(){var e=this.Path();return e?t.pluck(e,1).reverse().join(" - "):m(this,"title")},Path:function(){var e=m(this,"path");return e&&e.push(["",m(this,"title")]),e},PageTitle:function(){return m(this,"name")+" - BB"},PageHeader:function(){return m(this,"title")||m(this,"name")},render:function(){return this.$el.html(d(this.template,{view:this})),this},renderitem:function(e){return d(e.edit?this.itemtemplate+"edit":this.itemtemplate,{item:e,view:this})}}),u=h.extend({deps:function(){return this.collection.fetchonce()&&this.options.collections.projects.fetchonce()},path:function(){return[s,[r+"/"+(this.model.get("company")&&this.model.get("company").id),this.model.get("company")&&this.model.get("company").name],a,[p+"/"+this.model.id,this.model.name()]]}}),f=u.extend({previous:function(e){return e.preventDefault(),this.collection.hasPrevious()&&this.collection.getPreviousPage()},next:function(e){return e.preventDefault(),this.collection.hasNext()&&this.collection.getNextPage()}}),v=u.extend({cur_item:null,title:function(){return m(this,"itemtitle")},itemtitle:function(){var e=t.isFinite(this.cur_item)?this.collection.get(this.cur_item):this.cur_item;return e&&e.name()},nameParent:"",basepath:function(){var e=u.prototype.path.apply(this);return e.push([p+"/"+this.model.id+"/"+(this.idParent||this.nameParent.toLowerCase()),this.nameParent]),e},extrapath:[],path:function(){var e=m(this,"basepath"),o=m(this,"extrapath");return t.each(o,function(t){return e.push(t)}),e}}),g=h.prototype;return n.AllPeopleView=h.extend({deps:function(){return this.collection.fetchonce()&&this.options.collections.companies.fetchonce()},template:"#people",itemtemplate:"#personitem",title:"People"}),n.ProjectsView=h.extend({template:p,title:l}),n.ProjectView=h.extend({deps:function(){return this.options.collections.projects.fetchonce()},path:function(){return u.prototype.path.apply(this).slice(0,-1)},template:"#project"}),n.CompaniesView=h.extend({template:r,title:c}),n.CompanyView=h.extend({deps:function(){return this.options.collections.companies.fetchonce()&&this.options.collections.projects.fetchonce()&&this.options.collections.people.fetchonce()},path:function(){return[s]},template:"#company"}),n.PeopleView=u.extend({deps:function(){return this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.options.collections.companies.fetchonce()},template:"#project-people",itemtemplate:"#personitem",title:"People"}),n.PersonView=v.extend({template:"#project-person",itemtemplate:"#personitem",nameParent:"People"}),n.TimeEntriesView=f.extend({deps:function(){return this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.options.collections.people.fetchonce()},pagerid:"project-time",events:{"click .project-time.previous":"previous","click .project-time.next":"next","click .project-time #add":"addtime","click .project-time #edit":"edittime","click .project-time #remove":"removetime","click .project-time #save":"savetime","click .project-time #reset":"resettime","click .project-time thead>tr>th":"sorttime"},parseData:function(e){var t={};return t.date=this.$(e+" [name=date]").val(),t.description=this.$(e+" [name=description]").val(),t.hours=parseFloat(this.$(e+" [name=hours]").val(),10),t["person-id"]=parseInt(this.$(e+" [name=person-id]").val(),10),t},finishItem:function(e){return e.set({"project-id":this.model.id,"person-name":this.options.collections.people.get(e.get("person-id")).name()},{silent:!0})},sorttime:function(t){t.preventDefault();var o=e(t.currentTarget).data("sort")||e(t.currentTarget).text();this.collection.setSorting(o,-this.collection.state.order),this.collection.fullCollection.sort()},addtime:function(e){e.preventDefault();var t=this;this.collection.create(this.parseData(".addtime"),{wait:!0,success:function(e){return t.finishItem(e),t.collection.fullCollection.comparator||t.collection.setSorting("id",1),t.collection.fullCollection.sort(),!0}}),this.render()},currentTarget:function(t){return this.collection.get(e(t.currentTarget).parents("tr").data("id"))},edittime:function(e){e.preventDefault(),this.currentTarget(e).edit=!0,this.render()},resettime:function(e){e.preventDefault(),this.currentTarget(e).edit=!1,this.render()},removetime:function(e){e.preventDefault(),this.currentTarget(e).destroy(),this.render()},savetime:function(e){e.preventDefault();var t=this.currentTarget(e);t.edit=!1,t.save(this.parseData(".edittime[data-id="+t.id+"]")),this.render()},itemtemplate:"#time",template:"#project-time",title:"Time"}),n.TodoTimeEntriesView=n.TimeEntriesView.extend({pagerid:"todo-time",events:{"click .todo-time.previous":"previous","click .todo-time.next":"next","click .todo-time #add":"addtime","click .todo-time #edit":"edittime","click .todo-time #remove":"removetime","click .todo-time #save":"savetime","click .todo-time #reset":"resettime","click .todo-time thead>tr>th":"sorttime"},finishItem:function(e){return e.set({"project-id":this.model.id,"todo-item-id":this.cur_item,"person-name":this.options.collections.people.get(e.get("person-id")).name()},{silent:!0})},template:"#todo-time"}),n.TimeReportView=n.TimeEntriesView.extend({deps:function(){return this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.options.collections.people.fetchonce()&&this.options.collections.companies.fetchonce()},pagerid:"time-report",events:{"click .time-report.previous":"previous","click .time-report.next":"next","click #getreport":"getreport","click .time-report #edit":"edittime","click .time-report #remove":"removetime","click .time-report #save":"savetime","click .time-report #reset":"resettime","click .time-report thead>tr>th":"sorttime"},getreport:function(o){o.preventDefault(),this.collection.filter_report=e.param(t.filter(this.$("form#makereport").serializeArray(),function(e){return e.value})),this.collection.fetch({cache:!0,reset:!0})},template:"#time-report",path:!1,title:"Time report",render:function(){return g.render.apply(this),this.collection.filter_report&&this.$el.find("form#makereport").deserialize(this.collection.filter_report),this}}),n.PostCommentsView=v.extend({deps:function(){return this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.options.collections.project_posts.get_or_create(this.model.id).fetchonce()},template:"#project-post-comments",itemtemplate:"#post",extrapath:function(){return[[p+"/"+this.model.id+"/"+(this.idParent||this.nameParent.toLowerCase())+"/"+this.cur_item,m(this,"itemname")]]},nameParent:"Posts",itemname:function(){var e=t.isFinite(this.cur_item)&&this.options.collections.project_posts.get_or_create(this.model.id).get(this.cur_item),o=e&&e.name();return o},title:"Comments"}),n.CalendarEntryCommentsView=n.PostCommentsView.extend({deps:function(){return this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.options.collections.project_calendar.get_or_create(this.model.id).fetchonce()},template:"#project-calendar-entry-comments",itemtemplate:"#calendar",nameParent:"Calendar",itemname:function(){var e=t.isFinite(this.cur_item)&&this.options.collections.project_calendar.get_or_create(this.model.id).get(this.cur_item),o=e&&e.name();return o}}),n.PostsView=u.extend({template:"#project-posts",itemtemplate:"#post",title:"Posts"}),n.PostView=v.extend({template:"#project-post",itemtemplate:"#post",nameParent:"Posts"}),n.FilesView=f.extend({deps:function(){return this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.options.collections.people.fetchonce()&&this.options.collections.project_categories.get_or_create(this.model.id).fetchonce()},pagerid:"project-files",events:{"click .project-files.previous":"previous","click .project-files.next":"next"},itemtemplate:"#file",template:"#project-files",title:"Files"}),n.FileView=v.extend({deps:n.FilesView.prototype.deps,itemtemplate:"#file",template:"#project-file",nameParent:"Files"}),n.CalendarView=u.extend({template:"#project-calendar",itemtemplate:"#calendar",title:"Calendar"}),n.CalendarEntryView=v.extend({template:"#project-calendar-entry",itemtemplate:"#calendar",nameParent:"Calendar"}),n.CategoriesView=f.extend({pagerid:"project-categories",events:{"click .project-categories.previous":"previous","click .project-categories.next":"next"},template:"#project-categories",itemtemplate:"#category",title:"Categories"}),n.CategoryView=v.extend({template:"#project-category",itemtemplate:"#category",nameParent:"Categories"}),n.AllPersonView=h.extend({deps:function(){return this.options.collections.people.fetchonce()&&this.options.collections.companies.fetchonce()},template:"#person",path:function(){return[["#people","People"]]}}),n.TodosView=h.extend({deps:n.TimeEntriesView.prototype.deps,events:{"change select[name='target']":"selectTarget"},selectTarget:function(t){this.collection.responsible_party=e(t.target).val(),this.collection.fetch({cache:!0,reset:!0})},template:"#todo-lists",itemtemplate:"#todolist",title:function(){if(this.collection.responsible_party){var e=this.options.collections.people&&this.options.collections.people.get(this.collection.responsible_party);return e?e.name()+"'s to-dos":this.collection.responsible_party+"'s to-dos"}return null===this.collection.responsible_party?"My to-dos":""===this.collection.responsible_party?"Unassigned to-dos":"To-dos"},description:function(){if(this.collection.responsible_party){var e=this.options.collections.people&&this.options.collections.people.get(this.collection.responsible_party);return e?e.name()+"'s":this.collection.responsible_party+"'s"}return null===this.collection.responsible_party?"My":""===this.collection.responsible_party?"Unassigned":"All"}}),n.TodoListsView=u.extend({template:"#project-todo-lists",itemtemplate:"#todolist",title:"To-dos"}),n.TodoListView=v.extend({deps:function(){return this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.todos().fetchonce()&&this.options.collections.project_people.get_or_create(this.model.id).fetchonce()},events:{"click .project-todo-list .todo.icon-completed":"uncomplete","click .project-todo-list .todo.icon-uncompleted":"complete","click #add_todo #add":"addtodo"},todos:function(){return this.options.collections.todo_items.get_or_create(this.cur_item)},currentTarget:function(t){return this.todos().get(e(t.currentTarget).data("id"))},complete:function(e){e.preventDefault(),this.currentTarget(e).complete(),this.render()},uncomplete:function(e){e.preventDefault(),this.currentTarget(e).uncomplete(),this.render()},finishItem:function(e){return e.set({completed:!1,"todo-list-id":this.cur_item,"comments-count":0},{silent:!0})},addtodo:function(o){o.preventDefault();var i=e("form").serializeArray(),n=t.object(t.pluck(i,"name"),t.pluck(i,"value")),c=this;this.todos().create(n,{wait:!0,success:function(e){return c.finishItem(e),c.render(),!0}})},template:"#project-todo-list",itemtemplate:"#todolist",idParent:"todo_lists",nameParent:"To-dos"}),n.TodoItemView=n.TodoListView.extend({todo_item:null,deps:function(){return this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.todo_lists.fetchonce()&&this.todos().fetchonce()},events:{"click .project-todo-item .todo.icon-completed":"uncomplete","click .project-todo-item .todo.icon-uncompleted":"complete"},currentTarget:function(){return this.todos().get(this.todo_item)},template:"#project-todo-item",itemtemplate:"#todolist",extrapath:n.PostCommentsView.prototype.extrapath,itemname:function(){var e=this.cur_item&&this.todo_lists.get(this.cur_item),t=e&&e.name();return t},itemtitle:function(){var e=t.isFinite(this.todo_item)?this.todos().get(this.todo_item):this.todo_item,o=e&&e.name();return o}}),n.TodoItemCommentsView=n.TodoItemView.extend({template:"#project-todo-item-comments",events:{"click .project-todo-item-comments .todo.icon-completed":"uncomplete","click .project-todo-item-comments .todo.icon-uncompleted":"complete"},extrapath:function(){var e=n.TodoItemView.prototype.extrapath.apply(this);return[e.shift(),[p+"/"+this.model.id+"/"+(this.idParent||this.nameParent.toLowerCase())+"/"+this.cur_item+"/"+this.todo_item,m(this,"itemtitle")]]},title:"Comments"}),n.NavView=h.extend({template:"#nav",initialize:function(){this.model.bind("change",this.render,this)}}),n});