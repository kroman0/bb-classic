var onReset=function(){Backbone.history.loadUrl()};Backbone.Collection.prototype.fetchonce=function(){var e=this.fetched;return e||(this.fetched=!0,this.fetch({cache:!0})),e},Backbone.Collection.prototype.get_or_create=function(e){return this[e]||(this[e]=this.clone(),this[e].parent_id=e,this[e].on("reset",onReset)),this[e]},Backbone.View.prototype.render=function(){return this.$el.html(_.template($(this.template).html(),this,{variable:"view"})),this},uniq_hash=[];var add_hash=function(){if(window.workspace){var e=/^[#\/]|\s+$/g,t=_.map(_.filter(_.keys(workspace.routes),function(e){return e.indexOf("*")===-1}),function(e){return workspace._routeToRegExp(e)}),n=_.uniq(_.map($("a"),function(t){return t.hash.replace(e,"")}));while(h=n.pop())_.every(t,function(e){return!e.test(h)})&&uniq_hash.indexOf(h)==-1&&uniq_hash.push(h)}},Project=Backbone.Model.extend({icon:function(){switch(this.get("status")){case"active":return"icon-play";case"archived":return"icon-stop";case"on_hold":return"icon-pause"}}}),Company=Backbone.Model.extend(),Person=Backbone.Model.extend({name:function(){return this.get("first-name")+" "+this.get("last-name")}}),Post=Backbone.Model.extend(),Attachment=Backbone.Model.extend(),CalendarEntry=Backbone.Model.extend(),Category=Backbone.Model.extend(),TimeEntry=Backbone.Model.extend(),TodoItem=Backbone.Model.extend(),TodoList=Backbone.Model.extend(),Comment=Backbone.Model.extend(),MyModel=Person.extend({defaults:{id:null},url:"/api/me.xml"}),Projects=Backbone.Collection.extend({url:"/api/projects.xml",model:Project}),Companies=Backbone.Collection.extend({url:"/api/companies.xml",model:Company}),People=Backbone.Collection.extend({parent_id:null,url:function(){return this.parent_id?"/api/projects/"+this.parent_id+"/people.xml":"/api/people.xml"},model:Person}),Posts=Backbone.Collection.extend({parent_id:null,url:function(){return"/api/projects/"+this.parent_id+"/posts.xml"},model:Post}),Attachments=Backbone.PageableCollection.extend({mode:"client",parent_id:null,url:function(){return"/api/projects/"+this.parent_id+"/attachments.xml"},model:Attachment}),Calendar=Backbone.Collection.extend({parent_id:null,url:function(){return"/api/projects/"+this.parent_id+"/calendar_entries.xml"},model:CalendarEntry}),Categories=Backbone.Collection.extend({parent_id:null,url:function(){return"/api/projects/"+this.parent_id+"/categories.xml"},model:Category}),TimeEntries=Backbone.PageableCollection.extend({mode:"client",parent_id:null,parent:"projects",filter_report:null,url:function(){return this.parent_id?"/api/"+this.parent+"/"+this.parent_id+"/time_entries.xml":this.filter_report?"/api/time_entries/report.xml?"+this.filter_report:"/api/time_entries/report.xml"},model:TimeEntry}),TodoTimeEntries=TimeEntries.extend({parent:"todo_items"}),TodoItems=Backbone.Collection.extend({parent_id:null,url:function(){return"/api/todo_lists/"+this.parent_id+"/todo_items.xml"},model:TodoItem}),TodoLists=Backbone.Collection.extend({responsible_party:null,parent_id:null,filter_status:null,url:function(){return this.parent_id&&this.filter_status?"/api/projects/"+this.parent_id+"/todo_lists.xml?filter="+this.filter_status:this.parent_id?"/api/projects/"+this.parent_id+"/todo_lists.xml":this.responsible_party==null?"/api/todo_lists.xml":this.responsible_party==""?"/api/todo_lists.xml?responsible_party=":"/api/todo_lists.xml?responsible_party="+this.responsible_party},model:TodoList}),Comments=Backbone.Collection.extend({parent_id:null,parent_type:null,url:function(){return"/api/"+this.parent_type+"/"+this.parent_id+"/comments.xml"},model:Comment}),PostComments=Comments.extend({parent_type:"posts"}),TodoComments=Comments.extend({parent_type:"todo_items"}),CalendarEntryComments=Comments.extend({parent_type:"milestones"}),TimeReportView=Backbone.View.extend({deps:function(){this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.options.collections.people.fetchonce()&&this.options.collections.companies.fetchonce()},events:{"click .time-report.previous":"previous","click .time-report.next":"next","click #getreport":"getreport"},previous:function(e){e.preventDefault(),this.collection.hasPrevious()&&this.collection.getPreviousPage()},next:function(e){e.preventDefault(),this.collection.hasNext()&&this.collection.getNextPage()},getreport:function(e){e.preventDefault(),this.collection.filter_report=this.$("form#makereport").serialize(),this.collection.fetch({cache:!0})},template:"#time-report-template",name:function(){return"Time report"},render:function(){return this.$el.html(_.template($(this.template).html(),this,{variable:"view"})),this.collection.filter_report&&this.$el.find("form#makereport").deserialize(this.collection.filter_report),this}}),AllPeopleView=Backbone.View.extend({deps:function(){this.collection.fetchonce()&&this.options.collections.companies.fetchonce()},template:"#people-template",name:function(){return"People"}}),ProjectsView=Backbone.View.extend({deps:function(){this.collection.fetchonce()},template:"#projects-template",name:function(){return"Projects"}}),ProjectView=Backbone.View.extend({deps:function(){this.options.collections.projects.fetchonce()},template:"#project-template",name:function(){return this.model.get("name")}}),CompaniesView=Backbone.View.extend({deps:function(){this.collection.fetchonce()},template:"#companies-template",name:function(){return"Companies"}}),CompanyView=Backbone.View.extend({deps:function(){this.options.collections.companies.fetchonce()&&this.options.collections.projects.fetchonce()&&this.options.collections.people.fetchonce()},template:"#company-template",name:function(){return this.model.get("name")}}),PeopleView=Backbone.View.extend({deps:function(){this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.options.collections.companies.fetchonce()},template:"#project-people-template",name:function(){return this.model.get("name")+" > People"}}),TimeEntriesView=Backbone.View.extend({deps:function(){this.collection.fetchonce()&&this.options.collections.projects.fetchonce()},events:{"click .project-time.previous":"previous","click .project-time.next":"next"},previous:function(e){e.preventDefault(),this.collection.hasPrevious()&&this.collection.getPreviousPage()},next:function(e){e.preventDefault(),this.collection.hasNext()&&this.collection.getNextPage()},template:"#project-time-template",name:function(){return this.model.get("name")+" > Time"}}),TodoTimeEntriesView=TimeEntriesView.extend({events:{"click .todo-time.previous":"previous","click .todo-time.next":"next"},template:"#todo-time-template"}),PostCommentsView=Backbone.View.extend({cur_item:null,deps:function(){this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.options.collections.project_posts.get_or_create(this.model.id).fetchonce()},template:"#project-post-comments-template",name:function(){var e=this.cur_item&&this.options.collections.project_posts.get_or_create(this.model.id).get(this.cur_item),t=e&&e.get("title");return this.model.get("name")+" > Posts > "+t+" > Comments"}}),CalendarEntryCommentsView=Backbone.View.extend({cur_item:null,deps:function(){this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.options.collections.project_calendar.get_or_create(this.model.id).fetchonce()},template:"#project-calendar-entry-comments-template",name:function(){var e=this.cur_item&&this.options.collections.project_calendar.get_or_create(this.model.id).get(this.cur_item),t=e&&e.get("title");return this.model.get("name")+" > Calendar > "+t+" > Comments"}}),PostsView=Backbone.View.extend({deps:function(){this.collection.fetchonce()&&this.options.collections.projects.fetchonce()},template:"#project-posts-template",name:function(){return this.model.get("name")+" > Posts"}}),PostView=Backbone.View.extend({cur_item:null,deps:function(){this.collection.fetchonce()&&this.options.collections.projects.fetchonce()},template:"#project-post-template",name:function(){var e=this.cur_item&&this.collection.get(this.cur_item),t=e&&e.get("title");return this.model.get("name")+" > Posts > "+t}}),FilesView=Backbone.View.extend({deps:function(){this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.options.collections.people.fetchonce()&&this.options.collections.project_categories.get_or_create(this.model.id).fetchonce()},events:{"click .project-files.previous":"previous","click .project-files.next":"next"},previous:function(e){e.preventDefault(),this.collection.hasPrevious()&&this.collection.getPreviousPage()},next:function(e){e.preventDefault(),this.collection.hasNext()&&this.collection.getNextPage()},template:"#project-files-template",name:function(){return this.model.get("name")+" > Files"}}),FileView=Backbone.View.extend({cur_item:null,deps:function(){this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.options.collections.people.fetchonce()&&this.options.collections.project_categories.get_or_create(this.model.id).fetchonce()},template:"#project-file-template",name:function(){var e=this.cur_item&&this.collection.get(this.cur_item),t=e&&e.get("name");return this.model.get("name")+" > Files > "+t}}),CalendarView=Backbone.View.extend({deps:function(){this.collection.fetchonce()&&this.options.collections.projects.fetchonce()},template:"#project-calendar-template",name:function(){return this.model.get("name")+" > Calendar"}}),CalendarEntryView=Backbone.View.extend({cur_item:null,deps:function(){this.collection.fetchonce()&&this.options.collections.projects.fetchonce()},template:"#project-calendar-entry-template",name:function(){var e=this.cur_item&&this.collection.get(this.cur_item),t=e&&e.get("title");return this.model.get("name")+" > Calendar > "+t}}),CategoriesView=Backbone.View.extend({deps:function(){this.collection.fetchonce()&&this.options.collections.projects.fetchonce()},template:"#project-categories-template",name:function(){return this.model.get("name")+" > Categories"}}),CategoryView=Backbone.View.extend({cur_item:null,deps:function(){this.collection.fetchonce()&&this.options.collections.projects.fetchonce()},template:"#project-category-template",name:function(){var e=this.cur_item&&this.collection.get(this.cur_item),t=e&&e.get("name");return this.model.get("name")+" > Categories > "+t}}),PersonView=Backbone.View.extend({deps:function(){this.options.collections.people.fetchonce()&&this.options.collections.companies.fetchonce()},template:"#person-template",name:function(){return this.model.name()}}),TodosView=Backbone.View.extend({deps:function(){this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.options.collections.people.fetchonce()},events:{"change select[name='target']":"selectTarget"},selectTarget:function(e){this.collection.responsible_party=$(e.target).val(),this.collection.fetch({cache:!0})},template:"#todo-lists-template",name:function(){if(this.collection.responsible_party){var e=this.options.collections.people&&this.options.collections.people.get(this.collection.responsible_party);return e?e.name()+"'s to-dos":this.collection.responsible_party+"'s to-dos"}return this.collection.responsible_party==null?"My to-dos":this.collection.responsible_party==""?"Unassigned to-dos":"To-dos"},description:function(){if(this.collection.responsible_party){var e=this.options.collections.people&&this.options.collections.people.get(this.collection.responsible_party);return e&&e.name()+"'s"||this.collection.responsible_party+"'s"}return this.collection.responsible_party==null?"My":this.collection.responsible_party==""?"Unassigned":"All"}}),TodoListsView=Backbone.View.extend({deps:function(){this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.sub()},events:{"click .project-todo-lists.icon-completed":"uncomplete","click .project-todo-lists.icon-uncompleted":"complete"},complete:function(e){var t=$(e.target),n=parseInt(t.data("todolist-id")),r=parseInt(t.data("todoitem-id")),i=this.options.collections.todo_items,s=i.get_or_create(n),o=s.get(r);o.set("completed",!0),this.render()},uncomplete:function(e){var t=$(e.target),n=parseInt(t.data("todolist-id")),r=parseInt(t.data("todoitem-id")),i=this.options.collections.todo_items,s=i.get_or_create(n),o=s.get(r);o.set("completed",!1),this.render()},template:"#project-todo-lists-template",sub:function(){var e=this.options.collections.todo_items,t=_.map(this.collection.pluck("id"),function(t){return e.get_or_create(t)}),n=_.first(t.filter(function(e){return!e.fetched}));n&&(n.fetched=!0,n.fetch({cache:!0}))},name:function(){return this.collection.parent_id?this.model.get("name")+" > To-dos":"To-dos"}}),TodoListView=Backbone.View.extend({cur_item:null,deps:function(){this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.options.collections.todo_items.get_or_create(this.cur_item).fetchonce()},events:{"click .project-todo-list.icon-completed":"uncomplete","click .project-todo-list.icon-uncompleted":"complete"},complete:function(e){var t=$(e.target),n=parseInt(t.data("todolist-id")),r=parseInt(t.data("todoitem-id")),i=this.options.collections.todo_items,s=i.get_or_create(n),o=s.get(r);o.set("completed",!0),this.render()},uncomplete:function(e){var t=$(e.target),n=parseInt(t.data("todolist-id")),r=parseInt(t.data("todoitem-id")),i=this.options.collections.todo_items,s=i.get_or_create(n),o=s.get(r);o.set("completed",!1),this.render()},template:"#project-todo-list-template",name:function(){var e=this.cur_item&&this.collection.get(this.cur_item),t=e&&e.get("name");return this.model.get("name")+" > To-dos > "+t}}),TodoItemView=Backbone.View.extend({todo_item:null,cur_item:null,deps:function(){this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.options.collections.todo_items.get_or_create(this.cur_item).fetchonce()},events:{"click .project-todo-item.icon-completed":"uncomplete","click .project-todo-item.icon-uncompleted":"complete"},complete:function(e){var t=$(e.target),n=parseInt(t.data("todolist-id")),r=parseInt(t.data("todoitem-id")),i=this.options.collections.todo_items,s=i.get_or_create(n),o=s.get(r);o.set("completed",!0),this.render()},uncomplete:function(e){var t=$(e.target),n=parseInt(t.data("todolist-id")),r=parseInt(t.data("todoitem-id")),i=this.options.collections.todo_items,s=i.get_or_create(n),o=s.get(r);o.set("completed",!1),this.render()},template:"#project-todo-item-template",name:function(){var e=this.cur_item&&this.collection.get(this.cur_item),t=e&&e.get("name"),n=this.todo_item&&this.options.collections.todo_items.get_or_create(this.cur_item).get(this.todo_item),r=n&&n.get("content");return this.model.get("name")+" > To-dos > "+t+" > "+r}}),TodoItemCommentsView=Backbone.View.extend({todo_item:null,cur_item:null,deps:function(){this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.todo_lists.fetchonce()&&this.options.collections.todo_items.get_or_create(this.cur_item).fetchonce()},events:{"click .project-todo-item-comments.icon-completed":"uncomplete","click .project-todo-item-comments.icon-uncompleted":"complete"},complete:function(e){var t=$(e.target),n=parseInt(t.data("todolist-id")),r=parseInt(t.data("todoitem-id")),i=this.options.collections.todo_items,s=i.get_or_create(n),o=s.get(r);o.set("completed",!0),this.render()},uncomplete:function(e){var t=$(e.target),n=parseInt(t.data("todolist-id")),r=parseInt(t.data("todoitem-id")),i=this.options.collections.todo_items,s=i.get_or_create(n),o=s.get(r);o.set("completed",!1),this.render()},template:"#project-todo-item-comments-template",name:function(){var e=this.cur_item&&this.todo_lists.get(this.cur_item),t=e&&e.get("name"),n=this.todo_item&&this.options.collections.todo_items.get_or_create(this.cur_item).get(this.todo_item),r=n&&n.get("content");return this.model.get("name")+" > To-dos > "+t+" > "+r+" > Comments"}}),NavView=Backbone.View.extend({template:"#nav-template",initialize:function(){this.model.bind("change",this.render,this)}});$(function(){models={},collections={};var e={el:".content",collections:collections};models.mydata=new MyModel,models.project=new Project,models.company=new Company,models.person=new Person,collections.projects=new Projects,collections.companies=new Companies,collections.people=new People,collections.todos=new TodoLists,collections.times=new TimeEntries,views={},views.current=null,views.projects=new ProjectsView(_.extend({collection:collections.projects},e)),views.companies=new CompaniesView(_.extend({collection:collections.companies},e)),views.people=new AllPeopleView(_.extend({collection:collections.people},e)),views.time_report=new TimeReportView(_.extend({collection:collections.times},e)),views.todos=new TodosView(_.extend({collection:collections.todos,mydata:models.mydata},e));for(i in collections)collections[i].on("reset",onReset);collections.project_people=new People,collections.project_categories=new Categories,collections.project_posts=new Posts,collections.project_files=new Attachments,collections.project_todo_lists=new TodoLists,collections.project_calendar=new Calendar,collections.project_time_entries=new TimeEntries,collections.todo_items=new TodoItems,collections.todo_time_entries=new TodoTimeEntries,collections.project_todo_item_comments=new TodoComments,collections.project_post_comments=new PostComments,collections.project_calendar_entry_comments=new CalendarEntryComments,views.company_view=new CompanyView(_.extend({model:models.company},e)),views.person_view=new PersonView(_.extend({model:models.person},e));var t=_.extend({model:models.project},e);views.project_view=new ProjectView(t),views.project_people=new PeopleView(t),views.project_categories=new CategoriesView(t),views.project_category=new CategoryView(t),views.project_posts=new PostsView(t),views.project_post=new PostView(t),views.project_todo_lists=new TodoListsView(t),views.project_todo_list=new TodoListView(t),views.project_todo_item=new TodoItemView(t),views.project_todo_item_comments=new TodoItemCommentsView(t),views.project_calendar=new CalendarView(t),views.project_calendar_entry=new CalendarEntryView(t),views.project_files=new FilesView(t),views.project_file=new FileView(t),views.project_time_entries=new TimeEntriesView(t),views.todo_time_entries=new TodoTimeEntriesView(t),views.project_post_comments=new PostCommentsView(t),views.project_calendar_entry_comments=new CalendarEntryCommentsView(t);var n=Backbone.Router.extend({routes:{projects:"projects","projects:tab":"projects","projects/:id":"project","projects/:id/todo_lists":"project_todo_lists","projects/:id/todo_lists/:tlid":"project_todo_list","projects/:id/todo_lists/:tlid/:tiid":"project_todo_item","projects/:id/todo_lists/:tlid/:tiid/comments":"project_todo_item_comments","projects/:id/time_entries/todo_items/:tiid":"todo_time_entries","projects/:id/time_entries":"project_time_entries","projects/:id/people":"project_people","projects/:id/posts":"project_posts","projects/:id/posts/:pid":"project_post","projects/:id/posts/:pid/comments":"project_post_comments","projects/:id/files":"project_files","projects/:id/files/:fid":"project_file","projects/:id/calendar":"project_calendar","projects/:id/calendar/:cid":"project_calendar_entry","projects/:id/calendar/:cid/comments":"project_calendar_entry_comments","projects/:id/categories":"project_categories","projects/:id/categories/:cid":"project_category",companies:"companies","companies/:id":"company",people:"people","people:tab":"people","people/:id":"person",me:"me",todos:"todos",time_report:"time_report","*actions":"defaultRoute"}});workspace=new n,workspace.on("route",function(e,t){if(["projects","companies","people","time_report","todos"].indexOf(e)!==-1)views.current=views[e].render();else if(["project_people","project_categories","project_time_entries","project_posts","project_files","project_calendar","project_todo_lists"].indexOf(e)!==-1){var n=parseInt(t[0]);collections.projects.get(n)?views[e].model=collections.projects.get(n):views[e].model.id=n,views[e].collection=collections[e].get_or_create(n),views.current=views[e].render()}else if(["project_post","project_file","project_calendar_entry","project_category","project_todo_list"].indexOf(e)!==-1){var n=parseInt(t[0]),r=parseInt(t[1]);collections.projects.get(n)?views[e].model=collections.projects.get(n):views[e].model.id=n,views[e].cur_item=r;switch(e){case"project_calendar_entry":views[e].collection=collections.project_calendar.get_or_create(n);break;case"project_category":views[e].collection=collections.project_categories.get_or_create(n);break;default:views[e].collection=collections[e+"s"].get_or_create(n)}views.current=views[e].render()}else if(["project_calendar_entry_comments","project_post_comments","todo_time_entries"].indexOf(e)!==-1){var n=parseInt(t[0]),i=parseInt(t[1]);collections.projects.get(n)?views[e].model=collections.projects.get(n):views[e].model.id=n,views[e].cur_item=i,views[e].collection=collections[e].get_or_create(i),views.current=views[e].render()}views.current&&$("title").html(views.current.name()+" - BB"),add_hash(),views.current&&views.current.deps&&views.current.deps(),$(_.filter($(".navbar ul.nav li").removeClass("active"),function(e){return $(e).find("a:visible")[0]&&document.location.hash.indexOf($(e).find("a:visible")[0].hash)!==-1})).addClass("active")}).on("route:project_todo_item",function(e,t,n){collections.projects.get(e)?views.project_todo_item.model=collections.projects.get(e):views.project_todo_item.model.id=e,views.project_todo_item.cur_item=t,views.project_todo_item.todo_item=n,views.project_todo_item.collection=collections.project_todo_lists.get_or_create(e),views.current=views.project_todo_item.render()}).on("route:project_todo_item_comments",function(e,t,n){collections.projects.get(e)?views.project_todo_item_comments.model=collections.projects.get(e):views.project_todo_item_comments.model.id=e,views.project_todo_item_comments.cur_item=t,views.project_todo_item_comments.todo_item=n,views.project_todo_item_comments.todo_lists=collections.project_todo_lists.get_or_create(e),views.project_todo_item_comments.collection=collections.project_todo_item_comments.get_or_create(n),views.current=views.project_todo_item_comments.render()}).on("route:project",function(e){collections.projects.get(e)?views.project_view.model=collections.projects.get(e):views.project_view.model.id=e,views.current=views.project_view.render()}).on("route:company",function(e){collections.companies.get(e)?views.company_view.model=collections.companies.get(e):views.company_view.model.id=e,views.current=views.company_view.render()}).on("route:person",function(e){collections.people.get(e)?views.person_view.model=collections.people.get(e):views.person_view.model.id=e,views.current=views.person_view.render()}).on("route:me",function(){views.person_view.model=models.mydata,views.current=views.person_view.render()}).on("route:defaultRoute",function(e){this.navigate("projects",{trigger:!0})}),views.navbar=(new NavView({model:models.mydata,el:".navbar"})).render(),models.mydata.once("sync",function(){Backbone.history.start()}),models.mydata.fetch()});