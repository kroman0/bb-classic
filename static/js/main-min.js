$(function(){var e=function(){Backbone.history.loadUrl()};Backbone.Collection.prototype.fetchonce=function(){var e=this.fetched;return e||(this.fetch(),this.fetched=!0),e},Backbone.Collection.prototype.get_or_create=function(t){return this[t]||(this[t]=this.clone(),this[t].parent_id=t,this[t].on("reset",e)),this[t]},Backbone.View.prototype.render=function(){return this.$el.html(this.template()),this},uniq_hash=[];var t=function(){if(window.workspace){var e=/^[#\/]|\s+$/g,t=_.map(_.filter(_.keys(workspace.routes),function(e){return e.indexOf("*")===-1}),function(e){return workspace._routeToRegExp(e)}),n=_.uniq(_.map($("a"),function(t){return t.hash.replace(e,"")}));while(h=n.pop())_.every(t,function(e){return!e.test(h)})&&uniq_hash.indexOf(h)==-1&&uniq_hash.push(h)}},n=Backbone.Model.extend({icon:function(){switch(this.get("status")){case"active":return"icon-play";case"archived":return"icon-stop";case"on_hold":return"icon-pause"}}}),r=Backbone.Collection.extend({url:"/api/projects.xml",model:n}),s=Backbone.Model.extend(),o=Backbone.Collection.extend({url:"/api/companies.xml",model:s}),u=Backbone.Model.extend({name:function(){return this.get("first-name")+" "+this.get("last-name")}}),a=Backbone.Collection.extend({parent_id:null,url:function(){return this.parent_id?"/api/projects/"+this.parent_id+"/people.xml":"/api/people.xml"},model:u}),f=Backbone.Model.extend(),l=Backbone.Collection.extend({parent_id:null,url:function(){return"/api/projects/"+this.parent_id+"/posts.xml"},model:f}),c=Backbone.Model.extend(),p=Backbone.Collection.extend({parent_id:null,url:function(){return"/api/projects/"+this.parent_id+"/attachments.xml"},model:c}),d=Backbone.Model.extend(),v=Backbone.Collection.extend({parent_id:null,url:function(){return"/api/projects/"+this.parent_id+"/calendar_entries.xml"},model:d}),m=Backbone.Model.extend(),g=Backbone.Collection.extend({parent_id:null,url:function(){return"/api/projects/"+this.parent_id+"/categories.xml"},model:m}),y=Backbone.Model.extend(),b=Backbone.Collection.extend({parent_id:null,parent:null,filter_report:null,url:function(){return this.parent_id&&this.parent=="todo"?"/api/todo_items/"+this.parent_id+"/time_entries.xml":this.parent_id?"/api/projects/"+this.parent_id+"/time_entries.xml":this.filter_report?"/api/time_entries/report.xml?"+this.filter_report:"/api/time_entries/report.xml"},model:y}),w=Backbone.Model.extend(),E=Backbone.Collection.extend({parent_id:null,url:function(){return"/api/todo_lists/"+this.parent_id+"/todo_items.xml"},model:w}),S=Backbone.Model.extend(),x=Backbone.Collection.extend({responsible_party:null,parent_id:null,filter_status:null,url:function(){return this.parent_id&&this.filter_status?"/api/projects/"+this.parent_id+"/todo_lists.xml?filter="+this.filter_status:this.parent_id?"/api/projects/"+this.parent_id+"/todo_lists.xml":this.responsible_party==null?"/api/todo_lists.xml":this.responsible_party==""?"/api/todo_lists.xml?responsible_party=":"/api/todo_lists.xml?responsible_party="+this.responsible_party},model:S}),T=Backbone.View.extend({deps:function(){this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.options.collections.people.fetchonce()&&this.options.collections.companies.fetchonce()},events:{"click #getreport":"getreport"},getreport:function(e){e.preventDefault(),this.collection.filter_report=this.$("form#makereport").serialize(),this.collection.fetch()},template:_.template($("#time-report-template").html()),name:function(){return"Time report"},render:function(){return this.$el.html(this.template()),this.collection.filter_report&&this.$el.find("form#makereport").deserialize(this.collection.filter_report),this}}),N=Backbone.View.extend({deps:function(){this.collection.fetchonce()&&this.options.collections.companies.fetchonce()},template:_.template($("#people-template").html()),name:function(){return"People"}}),C=Backbone.View.extend({deps:function(){this.collection.fetchonce()},template:_.template($("#projects-template").html()),name:function(){return"Projects"}}),k=Backbone.View.extend({deps:function(){this.options.collections.projects.fetchonce()},template:_.template($("#project-template").html()),name:function(){return this.model.get("name")}}),L=Backbone.View.extend({deps:function(){this.collection.fetchonce()},template:_.template($("#companies-template").html()),name:function(){return"Companies"}}),A=Backbone.View.extend({deps:function(){this.options.collections.companies.fetchonce()&&this.options.collections.projects.fetchonce()&&this.options.collections.people.fetchonce()},template:_.template($("#company-template").html()),name:function(){return this.model.get("name")}}),O=Backbone.View.extend({deps:function(){this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.options.collections.companies.fetchonce()},template:_.template($("#project-people-template").html()),name:function(){return this.model.get("name")+" > People"}}),M=Backbone.View.extend({deps:function(){this.collection.fetchonce()&&this.options.collections.projects.fetchonce()},template:_.template($("#project-time-template").html()),name:function(){return this.model.get("name")+" > Time"}}),D=Backbone.View.extend({deps:function(){this.collection.fetchonce()&&this.options.collections.projects.fetchonce()},template:_.template($("#project-posts-template").html()),name:function(){return this.model.get("name")+" > Posts"}}),P=Backbone.View.extend({cur_item:null,deps:function(){this.collection.fetchonce()&&this.options.collections.projects.fetchonce()},template:_.template($("#project-post-template").html()),name:function(){var e=this.cur_item&&this.collection.get(this.cur_item),t=e&&e.get("title");return this.model.get("name")+" > Posts > "+t}}),H=Backbone.View.extend({deps:function(){this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.options.collections.people.fetchonce()&&this.options.collections.project_categories.get_or_create(this.model.id).fetchonce()},template:_.template($("#project-files-template").html()),name:function(){return this.model.get("name")+" > Files"}}),B=Backbone.View.extend({cur_item:null,deps:function(){this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.options.collections.people.fetchonce()&&this.options.collections.project_categories.get_or_create(this.model.id).fetchonce()},template:_.template($("#project-file-template").html()),name:function(){var e=this.cur_item&&this.collection.get(this.cur_item),t=e&&e.get("name");return this.model.get("name")+" > Files > "+t}}),j=Backbone.View.extend({deps:function(){this.collection.fetchonce()&&this.options.collections.projects.fetchonce()},template:_.template($("#project-calendar-template").html()),name:function(){return this.model.get("name")+" > Calendar"}}),F=Backbone.View.extend({cur_item:null,deps:function(){this.collection.fetchonce()&&this.options.collections.projects.fetchonce()},template:_.template($("#project-calendar-entry-template").html()),name:function(){var e=this.cur_item&&this.collection.get(this.cur_item),t=e&&e.get("title");return this.model.get("name")+" > Calendar > "+t}}),I=Backbone.View.extend({deps:function(){this.collection.fetchonce()&&this.options.collections.projects.fetchonce()},template:_.template($("#project-categories-template").html()),name:function(){return this.model.get("name")+" > Categories"}}),q=Backbone.View.extend({cur_item:null,deps:function(){this.collection.fetchonce()&&this.options.collections.projects.fetchonce()},template:_.template($("#project-category-template").html()),name:function(){var e=this.cur_item&&this.collection.get(this.cur_item),t=e&&e.get("name");return this.model.get("name")+" > Categories > "+t}}),R=Backbone.View.extend({deps:function(){this.options.collections.people.fetchonce()&&this.options.collections.companies.fetchonce()},template:_.template($("#person-template").html()),name:function(){return this.model.name()}}),U=Backbone.View.extend({deps:function(){this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.options.collections.people.fetchonce()},events:{"change select[name='target']":"selectTarget"},selectTarget:function(e){this.collection.responsible_party=$(e.target).val(),this.collection.fetch()},template:_.template($("#todo-lists-template").html()),name:function(){if(this.collection.responsible_party){var e=this.options.collections.people&&this.options.collections.people.get(this.collection.responsible_party);return e?e.name()+"'s to-dos":this.collection.responsible_party+"'s to-dos"}return this.collection.responsible_party==null?"My to-dos":this.collection.responsible_party==""?"Unassigned to-dos":"To-dos"},description:function(){if(this.collection.responsible_party){var e=this.options.collections.people&&this.options.collections.people.get(this.collection.responsible_party);return e&&e.name()+"'s"||this.collection.responsible_party+"'s"}return this.collection.responsible_party==null?"My":this.collection.responsible_party==""?"Unassigned":"All"}}),z=Backbone.View.extend({deps:function(){this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.sub()},template:_.template($("#project-todo-lists-template").html()),sub:function(){var e=this.options.collections.todo_items,t=_.map(this.collection.pluck("id"),function(t){return e.get_or_create(t)}),n=_.first(t.filter(function(e){return!e.fetched}));n&&(n.fetched=!0,n.fetch())},name:function(){return this.collection.parent_id?this.model.get("name")+" > To-dos":"To-dos"}}),W=Backbone.View.extend({cur_item:null,deps:function(){this.collection.fetchonce()&&this.options.collections.projects.fetchonce()&&this.options.collections.todo_items.get_or_create(this.cur_item).fetchonce()},template:_.template($("#project-todo-lists-template").html()),name:function(){var e=this.cur_item&&this.collection.get(this.cur_item),t=e&&e.get("name");return this.model.get("name")+" > To-dos > "+t}}),X=Backbone.Model.extend({defaults:{id:null},name:function(){return this.get("first-name")+" "+this.get("last-name")},url:"/api/me.xml"}),V=Backbone.View.extend({template:_.template($("#nav-template").html()),initialize:function(){this.model.bind("change",this.render,this)}});models={},collections={};var J={el:".content",collections:collections};models.mydata=new X,models.project=new n,models.company=new s,models.person=new u,collections.projects=new r,collections.companies=new o,collections.people=new a,collections.todos=new x,collections.times=new b,views={},views.current=null,views.projects=new C(_.extend({collection:collections.projects},J)),views.companies=new L(_.extend({collection:collections.companies},J)),views.people=new N(_.extend({collection:collections.people},J)),views.time_report=new T(_.extend({collection:collections.times},J)),views.todos=new U(_.extend({collection:collections.todos,mydata:models.mydata},J));for(i in collections)collections[i].on("reset",e);collections.project_people=new a,collections.project_categories=new g,collections.project_posts=new l,collections.project_files=new p,collections.project_todo_lists=new x,collections.project_calendar=new v,collections.project_time_entries=new b,collections.todo_items=new E,views.company_view=new A(_.extend({model:models.company},J)),views.person_view=new R(_.extend({model:models.person},J));var K=_.extend({model:models.project},J);views.project_view=new k(K),views.project_people=new O(K),views.project_categories=new I(K),views.project_category=new q(K),views.project_posts=new D(K),views.project_post=new P(K),views.project_todo_lists=new z(K),views.project_todo_list=new W(K),views.project_calendar=new j(K),views.project_calendar_entry=new F(K),views.project_files=new H(K),views.project_file=new B(K),views.project_time_entries=new M(K),collections.projects.on("reset",function(){this.each(function(e){collections.project_people.get_or_create(e.id),collections.project_categories.get_or_create(e.id),collections.project_posts.get_or_create(e.id),collections.project_todo_lists.get_or_create(e.id),collections.project_calendar.get_or_create(e.id),collections.project_categories.get_or_create(e.id),collections.project_files.get_or_create(e.id),collections.project_time_entries.get_or_create(e.id)})});var Q=Backbone.Router.extend({routes:{projects:"projects","projects:tab":"projects","projects/:id":"project","projects/:id/todo_lists":"project_todo_lists","projects/:id/todo_lists/:tlid":"project_todo_list","projects/:id/todo_lists/:tlid/todo_items/:tiid":"project_todo_item","projects/:id/time_entries":"project_time_entries","projects/:id/people":"project_people","projects/:id/posts":"project_posts","projects/:id/posts/:pid":"project_post","projects/:id/files":"project_files","projects/:id/files/:fid":"project_file","projects/:id/calendar":"project_calendar","projects/:id/calendar/:cid":"project_calendar_entry","projects/:id/categories":"project_categories","projects/:id/categories/:cid":"project_category","todo_items/:id/time_entries":"todo_time_entries",companies:"companies","companies/:id":"company",people:"people","people:tab":"people","people/:id":"person",me:"me",todos:"todos",time_report:"time_report","*actions":"defaultRoute"}});workspace=new Q,workspace.on("route",function(e,n){if(["projects","companies","people","time_report","todos"].indexOf(e)!==-1)views.current=views[e].render();else if(["project_people","project_categories","project_time_entries","project_posts","project_files","project_calendar","project_todo_lists"].indexOf(e)!==-1){var r=parseInt(n[0]);collections.projects.get(r)?views[e].model=collections.projects.get(r):views[e].model.id=r,views[e].collection=collections[e].get_or_create(r),views.current=views[e].render()}else if(["project_post","project_file","project_calendar_entry","project_category","project_todo_list"].indexOf(e)!==-1){var r=parseInt(n[0]),i=parseInt(n[1]);collections.projects.get(r)?(views[e].model=collections.projects.get(r),views[e].cur_item=i):(views[e].model.id=r,views[e].cur_item=i);switch(e){case"project_calendar_entry":views[e].collection=collections.project_calendar.get_or_create(r);break;case"project_category":views[e].collection=collections.project_categories.get_or_create(r);break;default:views[e].collection=collections[e+"s"].get_or_create(r)}views.current=views[e].render()}views.current&&$("title").html(views.current.name()+" - BB"),t(),views.current&&views.current.deps&&views.current.deps(),$(_.filter($(".navbar ul.nav li").removeClass("active"),function(e){return $(e).find("a:visible")[0]&&document.location.hash.indexOf($(e).find("a:visible")[0].hash)!==-1})).addClass("active")}).on("route:project",function(e){collections.projects.get(e)?views.project_view.model=collections.projects.get(e):views.project_view.model.id=e,views.current=views.project_view.render()}).on("route:company",function(e){collections.companies.get(e)?views.company_view.model=collections.companies.get(e):views.company_view.model.id=e,views.current=views.company_view.render()}).on("route:person",function(e){collections.people.get(e)?views.person_view.model=collections.people.get(e):views.person_view.model.id=e,views.current=views.person_view.render()}).on("route:me",function(){views.person_view.model=models.mydata,views.current=views.person_view.render()}).on("route:defaultRoute",function(e){this.navigate("projects",{trigger:!0})}),views.navbar=(new V({model:models.mydata,el:".navbar"})).render(),models.mydata.once("sync",function(){Backbone.history.start()}),models.mydata.fetch()});