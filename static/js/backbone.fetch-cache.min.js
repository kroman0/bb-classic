/*!
  backbone.fetch-cache v0.1.2 (2013-01-30)
  by Andy Appleton - https://github.com/mrappleton/backbone-fetch-cache.git
 */
(function(e,t){typeof define=="function"&&define.amd?define(["underscore","backbone"],function(n,r){return e.Backbone=t(n,r)}):e.Backbone=t(e._,e.Backbone)})(this,function(e,t){function s(n,r,i){r=r||{};var s=e.isFunction(n.url)?n.url():n.url,o=!1;if(!s)return;r.expires!==!1&&(o=(new Date).getTime()+(r.expires||300)*1e3),t.fetchCache._cache[s]={expires:o,value:i},t.fetchCache.setLocalStorage()}function o(){if(!i||!t.fetchCache.localStorage)return;localStorage.setItem("backboneCache",JSON.stringify(t.fetchCache._cache))}function u(){if(!i||!t.fetchCache.localStorage)return;t.fetchCache._cache=JSON.parse(localStorage.getItem("backboneCache"))||{}}var n=t.Model.prototype.fetch,r=t.Collection.prototype.fetch,i=typeof window.localStorage!="undefined";return t.fetchCache=t.fetchCache||{},t.fetchCache._cache=t.fetchCache._cache||{},typeof t.fetchCache.localStorage=="undefined"&&(t.fetchCache.localStorage=!0),t.Model.prototype.fetch=function(r){r=r||{};var i=e.isFunction(this.url)?this.url():this.url,s=t.fetchCache._cache[i],o=!1,u=!1,a=new $.Deferred;s&&(o=s.expires,o=o&&s.expires<(new Date).getTime(),u=s.value);if(!o&&(r.cache||r.prefill)&&u){this.set(u,r),e.isFunction(r.prefillSuccess)&&r.prefillSuccess(this);if(!r.prefill)return e.isFunction(r.success)&&r.success(this),a.resolve(this);a.notify(this)}return n.apply(this,arguments).done(e.bind(a.resolve,this,this)).done(e.bind(t.fetchCache.setCache,null,this,r)),a},t.Collection.prototype.fetch=function(n){n=n||{};var i=e.isFunction(this.url)?this.url():this.url,s=t.fetchCache._cache[i],o=!1,u=!1,a=new $.Deferred;s&&(o=s.expires,o=o&&s.expires<(new Date).getTime(),u=s.value);if(!o&&(n.cache||n.prefill)&&u){this[n.add?"add":"reset"](this.parse(u),n),e.isFunction(n.prefillSuccess)&&n.prefillSuccess(this);if(!n.prefill)return e.isFunction(n.success)&&n.success(this),a.resolve(this);a.notify(this)}return r.apply(this,arguments).done(e.bind(a.resolve,this,this)).done(e.bind(t.fetchCache.setCache,null,this,n)),a},u(),t.fetchCache.setCache=s,t.fetchCache.setLocalStorage=o,t.fetchCache.getLocalStorage=u,t});